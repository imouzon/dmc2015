---
title: Curation and Cross Validation to Reduce Features
titleshort: Too many features
instructions: 
output:
  usefulR::DMC_format
---

<!--- # (R code (No Results in Document)) -->
```{r set-parent, echo=FALSE,warning=FALSE,error=FALSE,message=FALSE,cache=TRUE,warning=FALSE,include=FALSE,comment=NA}
   #set up knitr
   #devtools::install_github('imouzon/usefulR')
   library(usefulR)

   #set working directory
   working.dir = "/Users/user/dmc2015/predictions"
   setwd(working.dir)

   #compile the document to PDF
   if(FALSE) 
      rmarkdown::render("/Users/user/dmc2015/predictions/combine_preds.rmd")
```

I am using the following packages:
<!--- # (R code (No Results in Document))-->
```{r paks, echo=TRUE, cache=FALSE, message=FALSE, tidy=FALSE, include=TRUE}
   library(magrittr)
   library(dplyr)
   library(reshape2)
   library(tidyr)
   library(lubridate)
   library(ggplot2)
   library(gridExtra)
   library(directlabels)
   library(rCharts)
   library(xtable)
   library(foreach)
   library(gtools)
   library(knitr)
   library(utils)
   library(GGally)
   source("~/dmc2015/ian/R/renm.R")
```

<!--- : R code (No Results in Document) -->
```{r cache=FALSE}
   predPlot = function(pred_set1,pred_set2){
     p = qplot(pred_set1,pred_set2) + coord_fixed() + geom_abline(intercept=0,slope=1,color="red")
     print(p)
     return(p)
   }

   lossFunction = function(pred,actual){ 
      actmat = matrix(actual,ncol=3,byrow=TRUE)
      predmat = matrix(pred,ncol=3,byrow=TRUE)
      numerat = colSums((actmat - predmat)^2)
      denom = colMeans(actmat)^2
      err = sum(numerat/denom)
      return(err)
   }

   predictor_weight = function(pred1,pred2,actual){
      alphas = seq(0,1,.001)
      err = sapply(alphas, function(alpha) lossFunction(alpha*pred1 + (1-alpha)*pred2, actual))
      pred = data.frame(proportion.1 = alphas, err = err)
      pred = qplot(proportion.1,err,data=pred)
      return(pred)
   }
```
My working directory is set to \verb!~/dmc2015/predictions/!.


# Set 1
I am using our new clean data - so should you
<!--- chunk-label: R code (No Results in Document) -->
```{r cache=FALSE}
   source("~/dmc2015/ian/load_data.r")
   HTVset1 = readRDS("~/dmc2015/data/featureMatrix/HTVset3.rds")
   actual.val = as.vector(t(HTVset1$V[,c("coupon1Used","coupon2Used","coupon3Used")]))
```

##Reading in the predictions
The predictions are stored in \verb!~/dmc2015/predictions/!.
We can read the files into R using the \verb!list.files! function.
<!--- : R code (No Results in Document) -->
```{r cache=FALSE}
   files = list.files("~/dmc2015/predictions/set3/",pattern="rds",full.names=TRUE)
   files

   #base names
   base_names = gsub("(/Users/user/dmc2015/predictions/set3//)(.*)(\\.rds)","\\2",files)
```
Many of the sets have the **DMC Official** structure:
<!--- : R code (No Results in Document) -->
```{r cache=FALSE}
   DMCofficial = readRDS("~/dmc2015/predictions/set1/crf_386col_set1_0.8.rds")
   str(DMCofficial)
```

I can check the structure in a similar way to how I read in features:
<!--- chunk-label: R code (No Results in Document) -->
```{r chunk-label,cache=FALSE}
   preds = lapply(files,function(x) readRDS(x))
   pred.struc = rep("renegade style",length(files))

   for(i in 1:length(files)){
      if(all(names(preds[[i]]) %in% names(DMCofficial))){
         pred.struc[i] = "DMC Official"
      }
      cat(pred.struc[i],": ", files[i],"\n")
   }

   pred.struc[11] = "DMC Official"
```

We can get the DMC official **validation predictions** like this:
<!--- chunk-label: R code (No Results in Document) -->
```{r cache=FALSE}
   #which files were DMC Official?
   these_ones = which(pred.struc == "DMC Official")

   #read the set
   validation_predictions = HTVset1$V %>% 
      select(orderID,coupon1Used,coupon2Used,coupon3Used) %>%
      gather(colname,couponUsed,-orderID) %>%
      mutate(couponCol = as.numeric(gsub("coupon(\\d)Used","\\1",colname))) %>%
      select(orderID,couponCol,couponUsed) %>% 
      arrange(orderID,couponCol) 

   #make do.call dplyr friendly
   you.call = function(x,func) do.call(func,x)

   #extract validation predictions
   pred.val = these_ones %>% 
      lapply(function(i) preds[[i]]$val_predictions) %>%
      you.call("cbind") %>%
      data.frame 

   names(pred.val) = base_names[these_ones]

   validation_predictions = validation_predictions %>% cbind(pred.val)
   names(validation_predictions)
```

and the DMC Official classification predictions like this:
<!--- chunk-label: R code (No Results in Document) -->
```{r cache=FALSE}
   classification_predictions = HTVset1$C %>%
      select(orderID, coupon1Used,coupon2Used,coupon3Used) %>%
      gather(colname,couponUsed,-orderID) %>%
      mutate(couponCol = as.numeric(gsub("coupon(\\d)Used","\\1",colname))) %>%
      select(orderID,couponCol,couponUsed) %>% 
      arrange(orderID,couponCol) 

   #extract validation predictions
   pred.class =  these_ones %>% 
      lapply(function(i) preds[[i]]$class_predictions[,2]) %>%
      you.call("cbind") %>%
      data.frame 

   #base names
   base_names = gsub("(/Users/user/dmc2015/predictions/set3//)(.*)(\\.rds)","\\2",files)

   names(pred.class) = base_names[these_ones]

   classification_predictions = classification_predictions %>% cbind(pred.class)
   names(classification_predictions)
```

And I can get the errors like this:
<!--- : R code (No Results in Document) -->
```{r cache=FALSE}
   validation_error = c()
   for(i in which(pred.struc == "DMC Official")){
      validation_error = c(validation_error, preds[[i]]$error[4])
   }

   method_name = which(pred.struc == "DMC Official")
```


The rest of the files follow the same arrangement:
```{r cache=FALSE}
   #get the validation predictions:
   validation_predictions$couponCol = as.numeric(validation_predictions$couponCol)
   classification_predictions$couponCol = as.numeric(classification_predictions$couponCol)

   #which(pred.struc == "renegade style")[9]
   #pred.struc = pred.struc[-9]
   for(i in which(pred.struc == "renegade style")){
      pred.i  = preds[[i]]$validation

      validation_predictions = validation_predictions %>% 
         left_join(pred.i,by=c("orderID","couponCol"))

      pred.i = preds[[i]]$class
      #get the validation predictions:
      classification_predictions = classification_predictions %>% 
         left_join(pred.i,by=c("orderID","couponCol"))

      validation_error = c(validation_error, preds[[i]]$err)
      method_name = c(method_name,i)
   }
```

Let's get the plots:
<!--- : R code (No Results in Document) -->
```{r cache=FALSE}
   qplot(method_name, validation_error)

   #drop errors
   qplot(method_name[-which(validation_error > 6700)], validation_error[-which(validation_error > 6700)])

   files[method_name[-which(validation_error > 6700)]]

   plot_func = function(i,j){
      if(i == j) p = qplot(validation_predictions[,i],geom='density',binwidth = .1)
      if(i < j) p = qplot(validation_predictions[,i],validation_predictions[,j])
      if(i > j) p = predictor_weight(validation_predictions[,i],validation_predictions[,j],validation_predictions[,3])
      return(p)
   }

   # ggpairs(validation_predictions,4:ncol(validation_predictions))
   cor(validation_predictions[,4:ncol(validation_predictions)])
   order(validation_error)

   plot_func(29,11) + ylim(6250,6400)
   # .45 * 29 + .55 * 11

   names(validation_predictions)[c(29,11)]
   order(rowSums(cor(validation_predictions)[c(rep(TRUE,3),validation_error < 6700),c(29,11)]))
   cor(validation_predictions)[13,c(29,11)]
   names(validation_predictions)[13]

   qplot(validation_predictions[,3],newpred3)
   newpred3 = .45*validation_predictions[,29] + .55*validation_predictions[,11]
   clspred3 = 
   .45*classification_predictions[,29] + .55*classification_predictions[,11]

   clspred3
   
   d = data.frame(cbind(
                        matrix(clspred3,ncol=3,byrow=TRUE)
                        )


   X = matrix(c(classification_predictions$orderID, clspred3),ncol=2,byrow=FALSE)
   head(X)
   d = matrix(
              ,ncol=3,byrow=TRUE)
   names(d) = c("coupon1Used","coupon2Used","coupon3Used")
   write.csv(d,"./predictions_based_on_3_cleaner.csv")



   names(validation_predictions)[c(29,11)]
sapply(4:ncol(validation_predictions), function(i) print(predictor_weight(newpred,validation_predictions[,i],validation_predictions[,3]))
       )
}

   


   names(safe_valid)[c(21,4)]
   files[order(-validation_error)[1:2]]
   
newpred = validation_predictions[,17]*.5 + validation_predictions[,4]*.5
addpred = validation_predictions[,7]

predictor_weight(newpred,addpred,validation_predictions[,3])


```




##Prediction Geometry
<!--- 
   val_predictions
   class_predictions
-->

