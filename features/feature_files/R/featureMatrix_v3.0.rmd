---
title: Feature Matrix 3
titleshort: FeatMat3
instructions: 
author: Ian Mouzon
authorshort: Mouzon
contact: imouzon@iastate.edu
grouplong: Data Mining Coupons
groupshort: DMC 2015
leader: Iowa State University Data Mining Cup Team
leadershort: DMC@ISU
semester: Spring 2015
assignment: 
duedate: May 5th, 2015
output:
  usefulR::hw_format
---

<!--- # (R code (No Results in Document)) -->
```{r set-parent,echo=FALSE,warning=FALSE,cache=FALSE,include=FALSE,comment=NA}
   #set up knitr
   #devtools::install_github('imouzon/usefulR')
   library(usefulR)

   #set working directory
   working.dir = '~/dmc2015/features/feature_files/R/'
   setwd(working.dir)

   #compile the document to PDF
   if(FALSE) 
      rmarkdown::render("featureMatrix_v3.0.rmd")
```

I am using the following packages to create this feature matrix:
<!--- packageLoad: R code (No Results in Document) -->
```{r packageLoad,cache=FALSE}
   library(ggplot2)
   library(lubridate)
   library(dplyr)
   library(reshape2)
   library(sqldf)
```

# Getting the data
I read the raw and clean data into R using the following simple commands:
<!--- readDat: R code (Code in Document) -->
```{r readDat, cache=FALSE}
   #training set ("historical data")
   trn.raw = read.delim("~/dmc2015/data/raw_data/DMC_2015_orders_train.txt", stringsAsFactors = FALSE, sep = "|", quote = "")
   trn = read.csv("~/dmc2015/data/clean_data/train_simple_name.csv", stringsAsFactors = FALSE,na.strings="")[,names(trn.raw)]

   #test set ("future data")
   cls.raw = read.delim("~/dmc2015/data/raw_data/DMC_2015_orders_class.txt", stringsAsFactors = FALSE, sep = "|", quote = "")
   cls = read.csv("~/dmc2015/data/clean_data/test_simple_name.csv", stringsAsFactors = FALSE,na.strings="")[,names(cls.raw)]
```

## Formatting the data
The data in thi raw form has the following formatting:
<!--- struch: R code (No Results in Document) -->
```{r struch,cache=FALSE}
   str(trn) 
```
We would like to properly format the data/time variables and convert factors to factors:
<!--- formatting: R code (No Results in Document) -->
```{r formatting,cache=FALSE}
   #first we stack together
   trn$dsn = "train"
   cls$dsn = "class"
   d = rbind(trn,cls)
   d$dsn = factor(d$dsn,levels=c("train","class"))

   #formatting orderTime
   d$orderTime = ymd_hms(d$orderTime)

   #formatting couponsReceived
   d$couponsReceived = ymd_hms(d$couponsReceived)

   #formatting userID
   d$userID = as.factor(d$userID)

   #formatting brands:
   d$brand1 = factor(d$brand1,levels=paste0("brand",1:length(unique(c(d$brand1,d$brand2,d$brand3)))))
   d$brand2 = factor(d$brand2,levels=paste0("brand",1:length(unique(c(d$brand1,d$brand2,d$brand3)))))
   d$brand3 = factor(d$brand3,levels=paste0("brand",1:length(unique(c(d$brand1,d$brand2,d$brand3)))))

   #formatting productGroups:
   d$productGroup1 = factor(d$productGroup1,levels=paste0("prod",1:length(unique(c(d$productGroup1,d$productGroup2,d$productGroup3)))))
   d$productGroup2 = factor(d$productGroup2,levels=paste0("prod",1:length(unique(c(d$productGroup1,d$productGroup2,d$productGroup3)))))
   d$productGroup3 = factor(d$productGroup3,levels=paste0("prod",1:length(unique(c(d$productGroup1,d$productGroup2,d$productGroup3)))))

   #formatting couponIDs:
   d$couponID1 = factor(d$couponID1,levels=paste0("cpn",1:length(unique(c(d$couponID1,d$couponID2,d$couponID3)))))
   d$couponID2 = factor(d$couponID2,levels=paste0("cpn",1:length(unique(c(d$couponID1,d$couponID2,d$couponID3)))))
   d$couponID3 = factor(d$couponID3,levels=paste0("cpn",1:length(unique(c(d$couponID1,d$couponID2,d$couponID3)))))
```
which gives the following structure:
<!--- structh: R code (No Results in Document) -->
```{r structh,cache=FALSE}
   str(d)
```
We can save this raw dataset first by splitting the pieces back up:
<!--- clnsimp: R code (No Results in Document) -->
```{r clnsimp,cache=FALSE}
   trn = d[which(d$dsn == "train"),] 
   trn = trn[,-which(names(trn) == "dsn")]
   cls = d[which(d$dsn == "class"),]
   cls = cls[,-which(names(cls) == "dsn")]
```
Then by writing the following \verb!RDS! file
```{r bel,cache=FALSE,eval=FALSE}
   saveRDS(list("train" = trn, "class" = cls),file="~/dmc2015/data/clean_data/clean_simple.rds")
```

#Adding the Features

## Batch ID
I read the batch ID file as follows:
%-- readBatch: R code (Code in Document)
<!--- batchIN: R code (No Results in Document) -->
```{r batchIN,cache=FALSE}
   #batch features in ~/dmc2015/features/feature_files/batchInfo_test.csv, batchInfo_train.csv
   bit = readRDS("~/dmc2015/features/feature_files/batchInfo_train.rds")
   bic = readRDS("~/dmc2015/features/feature_files/batchInfo_test.rds")
   bi = rbind(bit,bic)
```

### Check the batch to make sure it's clean
Check for no missing features:
<!--- checkftt: R code (No Results in Document) -->
```{r checkftt,cache=FALSE}
   #check for no missing values
   nrow(bi) - length(complete.cases(bi))
```

Fix the formatting:
<!--- btchfromt: R code (No Results in Document) -->
```{r btchfromt,cache=FALSE}
   bi$couponsReceivedTime =  period_to_seconds(bi$couponsReceivedTime)/3600
   bi$orderTimeTime =  period_to_seconds(bi$orderTimeTime)/3600

   bi = list("train" = bi[which(bi$orderID <= 6053),], "class" = bi[which(bi$orderID > 6053),])
```

## User Visit Features
<!--- userVisits: R code (No Results in Document) -->
```{r userVisits,cache=FALSE}
   uv = readRDS("~/dmc2015/features/feature_files/UserVisitFeatures.rds")

   #no missing values
   length(complete.cases(uv$train)) - nrow(uv$train)
```

##Coupon Basket Stats
<!--- couponUsed: R code (No Results in Document) -->
```{r couponUsed,cache=FALSE}
   cb = list("train" = readRDS("~/dmc2015/features/feature_files/coupon_basket_stats_train.rds"), "class" = readRDS("~/dmc2015/features/feature_files/coupon_basket_stats_class.rds"))
   cbXo = list("train" = readRDS("~/dmc2015/features/feature_files/coupon_basket_stats_train_byorder.rds"), "class" = readRDS("~/dmc2015/features/feature_files/coupon_basket_stats_class_byorder.rds"))
```

##Coupon Used
<!--- cou: R code (No Results in Document) -->
```{r cou,cache=FALSE}
   cu = list("train" = read.csv("~/dmc2015/features/feature_files/csv/couponUsed_train.csv"), "class" = read.csv("~/dmc2015/features/feature_files/csv/couponUsed_class.csv"))
```

##nCoup
<!--- nCoupon: R code (No Results in Document) -->
```{r nCoupon,cache=FALSE}
   nc = list("train" = read.csv("~/dmc2015/features/feature_files/csv/nCoupTrain.csv"), "class" = read.csv("~/dmc2015/features/feature_files/csv/nCoupClass.csv"))
```

# Putting the pieces together

We don't want any of these variables in our dataset:
<!--- chunk-label: R code (No Results in Document) -->
```{r chunk-label,cache=FALSE}
  bannedvars = c("orderID", "batchID", "couponID","couponID1","couponID2","couponID3") 
```


We create our X and y using these features:
<!--- : R code (No Results in Document) -->
```{r ,cache=FALSE}
  X = data.frame(orderID=trn$orderID)
  y = trn[,c("coupon1Used","coupon2Used","coupon3Used","basketValue")]

  X = X %>% left_join(bi$train,by="orderID") %>%
     left_join(uv$train,by="orderID") %>%
     left_join(cb$train,by="orderID") %>%
     left_join(cbXo$train,by="orderID") %>%
     left_join(cu$train,by="orderID") %>% 
     left_join(nc$train,by="orderID") %>%
     left_join(trn[,c("orderID","couponsReceived", "orderTime","price1","price2","price3","basePrice1","basePrice2","basePrice3","reward1","reward2","reward3","premiumProduct1","premiumProduct2","premiumProduct3")],by="orderID")

  X = X[,-(which(names(X) %in% bannedvars))]
```

and do the same for classification:
<!--- : R code (No Results in Document) -->
```{r ,cache=FALSE}
  X.cls = data.frame(orderID=cls$orderID)
  y.cls = cls[,c("coupon1Used","coupon2Used","coupon3Used","basketValue")]

  X.cls = X.cls %>% left_join(bi$class,by="orderID") %>%
     left_join(uv$class,by="orderID") %>%
     left_join(cb$class,by="orderID") %>%
     left_join(cbXo$class,by="orderID") %>%
     left_join(cu$class,by="orderID") %>%
     left_join(nc$class,by="orderID") %>%
     left_join(cls[,c("orderID","couponsReceived", "orderTime", "price1","price2","price3", "basePrice1","basePrice2","basePrice3", "reward1","reward2","reward3", "premiumProduct1","premiumProduct2","premiumProduct3")],by="orderID")

  X.cls = X.cls[,-(which(names(X.cls) %in% bannedvars))]
```

#Write the feature matrix
<!--- writeFeat: R code (No Results in Document) -->
```{r writeFeat,cache=FALSE}
   FeatMat3 = list("train" = list("X" = X, "y" = y), "class" = list("X" = X.cls, "y" = y.cls))

   saveRDS(FeatMat3, file="~/dmc2015/data/featureMatrix/featMat_v3.0.rds")
```
