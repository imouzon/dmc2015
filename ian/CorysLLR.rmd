---
title: Cory's LLR Statistics
titleshort: Cory's LLR
instructions:
author: Ian Mouzon
authorshort: Mouzon
contact: imouzon@iastate.edu
grouplong: Data Mining Cup 2015 
groupshort: DMC2015
leader: Iowa State University Data Mining Cup Team
leadershort: DMC2015@ISU
semester: Spring 2015
assignment: 
duedate: May 6, 2015
output:
  usefulR::hw_format
---

<!--- # (R code (No Results in Document)) -->
```{r set-parent, echo=FALSE,warning=FALSE,error=FALSE,message=FALSE,cache=TRUE,warning=FALSE,include=FALSE,comment=NA}
   #set up knitr
   #devtools::install_github('imouzon/usefulR')
   library(usefulR)

   #set working directory
   working.dir = '~/dmc2015/ian/'
   setwd(working.dir)

   #compile the document to PDF
   if(FALSE) 
      rmarkdown::render("~/dmc2015/ian/universal_features.rmd")
```

I am using the following pacakges:
<!--- # (R code (No Results in Document))-->
```{r paks, echo=TRUE, cache=FALSE, message=FALSE, tidy=FALSE, include=TRUE}
   library(ggplot2)
   library(lubridate)
   library(xtable)
   library(foreach)
   library(rCharts)
   library(magrittr)
   library(tidyr)
   library(dplyr)
   library(reshape2)
   library(gtools)
   library(sqldf)
   library(missForest)
```
and my working directory is set to \verb!dmc2015/ian!.

# Pete's LLR Code
<!--- chunk-label: R code (No Results in Document) -->
```{r PetesFunc1,cache=FALSE}
   source("~/dmc2015/pete/06_likelihood.R")
```

#Reading the data into R
<!--- chunk-label: R code (No Results in Document) -->
```{r readingInTheData,cache=FALSE}
   #clean data
   d = readRDS("~/dmc2015/data/clean_data/clean_simple.rds")
   S1 = readRDS("~/dmc2015/data/featureMatrix/HTVset1.rds")
   S2 = readRDS("~/dmc2015/data/featureMatrix/HTVset2.rds")
   S3 = readRDS("~/dmc2015/data/featureMatrix/HTVset3.rds")
```

# Calculating Coupon 1-Way Likelihoods
<!--- cpn1way: R code (No Results in Document) -->
```{r cpn1way,cache=FALSE}
   source("./R/stackCoupons.R")

   TV = stackCoupons(S1$T,S1$V,nms=c("train","validation"))
   TC = stackCoupons(S1$T,S1$C,nms=c("train","class"))
   TVC = TV$validation %>% rbind(TC$combined)
   H = stackCoupons(S1$T,S1$H,nms=c("train","historical"))$historical

   lls = compute_ll(as.character(H$couponID),H$couponUsed,TV$train$couponUsed)

   p = mean(H1$couponUsed)
   denom.eps = .5
   eps1 =  (p/(1-p))*denom.eps
   eps1/(eps1 + denom.eps)

   d = data.frame("couponID" = names(lls), "llr_couponID" = lls) %>% arrange(couponID)

   T1 = S1$T %>% merge(d,by.y="couponID",by.x="couponID1")
   T1 = T1 %>% merge(d,by.y="couponID",by.x="couponID2")
   T1 = T1 %>% merge(d,by.y="couponID",by.x="couponID3")

   %>% select("couponID1","llr_couponID")
   %>% unique

   d[which(is.na(d$llr_couponID))[1:5],]
   length(unique(S1$T$orderID))
    
   head(d)
   is.na(d$llr_couponID)

   qplot(couponID,llr_couponID,data=d)
   

   
```

