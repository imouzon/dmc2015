---
title: Feature Matrix Version 4.0
titleshort: Features (vers. 4)
instructions:
author: Ian Mouzon
authorshort: Mouzon
contact: imouzon@iastate.edu
grouplong: Iowa State University's 2015 Data Mining Cup Team
groupshort: DMC@ISU
leader: One Week Left 
leadershort: One Week Left
semester: Spring 2015
assignment: 
duedate: May 10, 2015
output:
  usefulR::hw_format:
---

<!--- # (R code (No Results in Document)) -->
```{r set-parent, echo=FALSE,warning=FALSE,error=FALSE,message=FALSE,cache=TRUE,warning=FALSE,include=FALSE,comment=NA}
   #set up knitr
   #devtools::install_github('imouzon/usefulR')
   library(usefulR)

   #set working directory
   working.dir = "/Users/user/dmc2015/features/feature_files/R"
   setwd(working.dir)

   #compile the document to PDF
   if(FALSE) 
      rmarkdown::render("/Users/user/dmc2015/features/feature_files/R/featureMatrix_v4.0.rmd")
```
I am using the following packages:
<!--- # (R code (No Results in Document))-->
```{r paks, echo=TRUE, cache=FALSE, message=FALSE, tidy=FALSE, include=TRUE}
   library(ggplot2)
   library(lubridate)
   library(xtable)
   library(foreach)
   library(rCharts)
   library(magrittr)
   library(tidyr)
   library(dplyr)
   library(reshape2)
   library(gtools)
   library(sqldf)
   library(missForest)
   source("./R/renm.R")
```
and our working directory is set to \verb!dmc2015/features/feature_files/R/!.

# Creating the feature matrix:

## Set 1: History Composed of Randomly Sampled Rows

This feature matrix will be composed of both universal features and historical features.
The features are based on the data sets contained in \verb!~/dmc2015/data/featureMatrix/HTVset1.rds/!.
I can read these sets into \verb!R! using:
<!--- : R code (No Results in Document) -->
```{r cache=FALSE}
   HTV1 = readRDS("~/dmc2015/data/featureMatrix/HTVset1.rds") 
   names(HTV1)
   names(HTV1$orderids)
```
There are some covariates in this file that we might want to keep: For instance, \verb!price!. We can do this as follows:
<!--- vars2keep: R code (No Results in Document) -->
```{r vars2keep,cache=FALSE,tidy=FALSE}
   covars2keep = c("brand1","price1","basePrice1","reward1","premiumProduct1",
                   "brand2","price2","basePrice2","reward2","premiumProduct2",
                   "brand3","price3","basePrice3","reward3","premiumProduct3",

                   "orderTimeTime",       "orderTimeFriSat",       "orderTimeDoW",       "orderTimeWeekend",
                   "couponsReceivedTime", "couponsReceivedFriSat", "couponsReceivedDoW", "couponsReceivedWeekend", 

                   "batchID", "couponsExpire", "couponsSent", 

                   "TimeBtwnSentRec", "TimeBtwnRecExpire", "TimeBtwnRecOrder", "TimeBtwnOrderExpire"
                   )
```
And of course we want to keep the value we need to predict:
<!--- : R code (No Results in Document) -->
```{r keepresponses,cache=FALSE}
   response_vars = c("coupon1Used","coupon2Used","coupon3Used","basketValue") 
```

The features created using this data are in the folder \verb!~/dmc2015/features/feature_files/set1/!
In order to know what files to read, I can use the following:
<!--- get_file_list: R code (No Results in Document) -->
```{r get_file_list,cache=FALSE}
   files = list.files("~/dmc2015/features/feature_files/set1/",full.names=TRUE)
```

Each file should contain a feature or set of features that can be added to the data frame by joining on \verb!orderID!. 
I wrote the following function to make sure that this works correctly:

<!--- read_files_into_R: R code (No Results in Document) -->
```{r read_files_into_R,cache=FALSE}
   createFeatureMatrix = function(HTV_list,keepHTVcolumns,response_columns){
      keepHTVcolumns = covars2keep
      if(!is.numeric(keepHTVcolumns)) keepHTVcolumns = which(names(HTV_list$T %in% keepHTVcolumns))
      if(!is.numeric(response_columns)) keepHTVcolumns = which(names(HTV_list$T %in% keepHTVcolumns))

   features = lapply(files, function(i) readRDS(i))
```




