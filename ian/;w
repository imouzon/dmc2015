---
title: Categorical Similarity Measures
titleshort: CatSims
author: Ian Mouzon
authorshort: imouzon
contact: imouzon@iastate.edu
grouplong: Iowa State University's 2015 Data Mining Cup Team
groupshort: DMC@ISU
leader:  
leadershort: 
semester: Spring 2015
assignment: 
duedate: May 8, 2015
output:
  usefulR::hw_format:
  keep_tex: true
---

<!--- # (R code (No Results in Document)) -->
```{r set-parent, echo=FALSE,warning=FALSE,error=FALSE,message=FALSE,cache=TRUE,warning=FALSE,include=FALSE,comment=NA}
   #set up knitr
   #devtools::install_github('imouzon/usefulR')
   library(usefulR)

   #set working directory
   working.dir = "~/dmc2015/ian"
   setwd(working.dir)

   #compile the document to PDF
   if(FALSE) 
      rmarkdown::render("./categorical_similarity.Rmd")
```
I am using the following packages:
<!--- # (R code (No Results in Document))-->
```{r paks, echo=TRUE, cache=FALSE, message=FALSE, tidy=FALSE, include=TRUE}
   library(ggplot2)
   library(lubridate)
   library(xtable)
   library(foreach)
   library(rCharts)
   library(magrittr)
   library(tidyr)
   library(dplyr)
   library(reshape2)
   library(gtools)
   library(sqldf)
   library(missForest)
   source("./R/renm.R")
```
and my working directory is set to \verb!dmc2015/ian!.

# Categorical Similarity
Oh My Gosh - did you know that you can compare categorical variables to each other?
You can create kind of like a distance on them.

One simple example based on the Jaccard Measure:

Let $\mathbf{u}$ and $\mathbf{v}$ be two multidimensional categorical variables
taking values in $A = \{a_1, a_2, \ldots, a_n\}$. Then we can think of these
as subsets of the the set $A$ in which case we can describe a similarity
between the coupons using
$$
   J(\mathbf{u}, \mathbf{v}) = \dfrac{| \mathbf{u} \cap \mathbf{v} |}{ \mathbf{u} \cup \mathbf{v}}
$$
In this document I am calculating some of these features for the categorical variables \verb!categoryIDs!.

# Getting Tranthe Data and Manipulations 
I am using our new clean data - so should you
<!--- chunk-label: R code (No Results in Document) -->
```{r chunk-label,cache=FALSE}
   d = readRDS("../data/clean_data/universalCleanData.rds")
```

I can melt the columns by coupon using the following:
<!--- : R code (No Results in Document) -->
```{r cache=FALSE}
   source("./r/stackCoupons2.R")
   dm = stackCoupons2(d,idcols = c(1:4,32:49))
```

I and can split the columns of product group using:
<!--- splitcols: R code (No Results in Document) -->
```{r splitcols,cache=FALSE}
   source("./r/splitColumn.R")
   dmc = splitColumn(dm,"categoryIDs","orderID",splitby=":") 
   dmcs = dmc[,c(1,23,32:37)] %>% 
      mutate(couponNum = as.numeric(gsub("cpn","",couponID))) %>% 
      arrange(orderID,couponID)

   #the number of coupons
   ncpns = length(unique(dmc$couponID))
```
Consider the unique coupon IDs and create a matrix with the columns 0 to 1 for whether or
not the coupon has the given category:
<!--- newmats: R code (No Results in Document) -->
```{r newmats,cache=FALSE}
   dmcsu = unique(dmcs[,c(2,9,4:8)]) %>% arrange(couponNum)

   dmcsuc = matrix(NA,nrow=nrow(dmcsu),ncol=31)
   for(i in 1:nrow(dmcsuc)) dmcsuc[i,] = 1*(paste0('cat',1:31) %in% dmcsu[i,2:6])

   catIndMat = dmcsu[,"couponID"] %>% cbind(data.frame(dmcsuc))
   names(catIndMat) = c("couponID",paste0("cat",1:31))
```
and save the jaccard matrix from this:
<!--- chunk-label: R code (No Results in Document) -->
```{r chunk-label,cache=TRUE}
   #these are the jaccard similarities
   jaccard_func = function(cpn1,cpn2) sum(cpn1 * cpn2)/sum(as.numeric(cpn1 + cpn2 > 0))

   dmcsuck = matrix(0,ncpns,ncpns)
   for(i in 1:ncpns) for(j in i:ncpns) dmcsuck[i,j] = jaccard_func(dmcsuc[i,],dmcsuc[j,])
```

# Jaccard Similarity Used To Describe Order
We can use these jaccard similaritys to describe our orders. Consider, for example,
the mean Jaccard similarity:

<!--- chunk-label: R code (No Results in Document) -->
```{r usejaccard, cache=FALSE}
   dmcsucks = d %>% arrange(orderID) %>% select(couponID1,couponID2,couponID3)
   dmcsucks[] = lapply(dmcsucks, as.character)
 
   JaccardSummary= function(i){
      x = which(paste0('cpn',1:ncpns) %in% dmcsucks[i,])
      rows = combn(x,2)[1,]
      cols = combn(x,2)[2,]
      sapply(1:3,function(j) dmcsuck[rows[j],cols[j]])
   }
   lapply(1:5, function(i) whichcpns(i))
   whichcpns(8)
                                             
   for(i in 1:nrow(dmcsucks)) dmcsuckss[i,] = 
   jaccard = sapply(1:nrow(dmcsucks), function(i) matrix(dmcsuckss[i,],nrow=1)%*%dmcsuck%*%matrix(dmcsuckss[i,],ncol=1)/6) 
   jaccard = jaccard - 3
```

Weighted Jaccard

# Categorical Similarity
<!--- : R code (No Results in Document) -->
```{r cache=FALSE}
   N = nrow(dmcsuc)*(nrow(dmcsuc) - 1)/2
   dmcsucd = data.frame('cpn1' = rep(NA,N),'cpn2'=rep(NA,N),jaccard=rep(NA,N))

   for(i in 1:(nrow(dmcsucd)-1)){
      for(j in (i+1):nrow(dmcsucd)){
         cpni = which(dmcsuc[,1] == paste0("cpn",i))
         cpnj = which(dmcsuc[,1] == paste0("cpn",j))

         dmcsucd[(31*(i-1) + j),] = c(paste0("cpn",i),paste0("cpn",j), sum(dmcsuc[cpni,2:32]*dmcsuc[cpnj,2:32]))
      }
   }
```

