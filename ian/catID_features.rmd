---
title: Getting Category IDs Under Control
author: none
course: DMC
date: April 29, 2015
---

[//]: # (R code (No Results in Document))
```{r set-parent, echo=FALSE,warning=FALSE,error=FALSE,message=FALSE,cache=TRUE,warning=FALSE,include=FALSE,comment=NA}
   #set up knit
   #devtools::install_github('imouzon/usefulR')
   library(usefulR)

   working.dir = "/Users/user/dmc2015/ian"
   setwd(working.dir)
   knitrSetup(rootDir=FALSE,use.tikz=TRUE)

   #set up file locations
   parent.file = makeParent(parentDir = getwd(),type="markdown",overwrite=FALSE)

   source("./R/renm.R")
```

I am using the following packages:
[//]: # (R code (No Results in Document))
```{r paks, echo=TRUE, cache=FALSE, message=FALSE, tidy=FALSE, include=TRUE}
   library(ggplot2)
   library(lubridate)
   library(xtable)
   library(foreach)
   library(rCharts)
   library(magrittr)
   library(tidyr)
   library(dplyr)
   library(reshape2)
   library(gtools)
   library(sqldf)
```
and my working directory is set to \verb!dmc2015/ian!.

# Reading the Data
I am working from the current feature matrix:
<!---  readFeatMat: R code (Code in Document) -->
```{r readFeatMat, echo=TRUE, cache=FALSE, tidy=FALSE, include = TRUE}
   featMat = readRDS("~/dmc2015/data/featureMatrix/featMat_v1.1.rds")
   trn = featMat$train
   cls = featMat$class

   #Also reading the melted train and test sets
   trn.m = read.csv("~/dmc2015/data/clean_data/melted_train_simple_name.csv")
   cls.m = read.csv("~/dmc2015/data/clean_data/melted_test_simple_name.csv")

   stack.trn = trn.m
   stack.trn$dsn = "trn"

   stack.cls = cls.m
   stack.cls$dsn = "cls"

   stack.m = rbind(stack.trn,stack.cls)

   stack.m$dsn = factor(stack.m$dsn,levels=c('trn','cls'))
```

In case I need to reference the raw data, I will read that too:
<!---  readRaw: R code (Code in Document) -->
```{r readRaw, echo=TRUE, cache=FALSE, tidy=FALSE, include = TRUE}
   raw.trn = read.csv("~/dmc2015/data/clean_data/train_simple_name.csv")
   raw.cls = read.csv("~/dmc2015/data/clean_data/test_simple_name.csv")
```

[//]: # (splitcols: R code (No Results in Document))
```{r splitcols,echo=FALSE,warning=FALSE,error=FALSE,message=FALSE,cache=TRUE,warning=FALSE,include=FALSE,comment=NA}
   source("~/dmc2015/ian/R/splitColumn.R")
   stack.m$categoryIDs = as.character(stack.m$categoryIDs)
   splitCats = splitColumn(stack.m,"categoryIDs","orderID",splitby=":")

   melt.cats = splitCats[,c(1,15:21)] %>% 
      gather(variable,value,-orderID,-couponCol,-dsn) %>% 
      arrange(orderID,couponCol,dsn) %>%
      select(-variable) %>%
      filter(!is.na(value)) 

   catFreq = melt.cats %>% 
      with(table(value)) %>% 
      data.frame %>% 
      arrange(-Freq) %>% 
      renm(c("catID","nTotal"))

   catFreq = melt.cats %>% with(table(value,couponCol)) %>% 
      data.frame %>% 
      arrange(-Freq) %>% 
      renm(c("catID","couponCol","nTotal")) %>%
      spread(couponCol,nTotal) %>%
      renm(c("catID","nTotalCol1","nTotalCol2","nTotalCol3")) %>%
      full_join(catFreq,by="catID")

   trn.m$categoryIDs = as.character(trn.m$categoryIDs)
   split.trn = splitColumn(trn.m,"categoryIDs","orderID",splitby=":")

   melt.trn = split.trn[,c(1,14:20)] %>% 
      gather(variable,value,-orderID,-couponCol,-couponUsed) %>% 
      arrange(orderID,couponCol) %>% 
      select(-variable) %>% 
      filter(!is.na(value))

   trnFreq = melt.trn %>% 
      with(table(value,couponCol)) %>% 
      data.frame %>% 
      arrange(-Freq) %>% 
      renm(c("catID","couponCol","nTotalUsed")) %>%
      spread(couponCol,nTotalUsed) %>%
      renm(c("catID","nTotalCol1","nTotalCol2","nTotalCol3"))

   trnFreq$nTotal = with(trnFreq,nTotalCol1 + nTotalCol2 + nTotalCol3)

   trnFreq = melt.trn %>% 
      filter(couponUsed == 1) %>% 
      with(table(value,couponCol)) %>% 
      data.frame %>% 
      arrange(-Freq) %>% 
      renm(c("catID","couponCol","nTotalUsed")) %>%
      spread(couponCol,nTotalUsed) %>%
      renm(c("catID","nTotalUsedCol1","nTotalUsedCol2","nTotalUsedCol3")) %>%
      full_join(trnFreq,by="catID")

   trnFreq[31,2:4] = 0

   trnFreq$nTotalUsed = with(trnFreq,nTotalUsedCol1 + nTotalUsedCol2 + nTotalUsedCol3)

   trnFreq$propUsedCol1 = trnFreq$nTotalUsedCol1/trnFreq$nTotalCol1
   trnFreq$propUsedCol2 = trnFreq$nTotalUsedCol2/trnFreq$nTotalCol2
   trnFreq$propUsedCol3 = trnFreq$nTotalUsedCol3/trnFreq$nTotalCol3
   trnFreq$propUsed = trnFreq$nTotalUsed/trnFreq$nTotal
   
   catFreq = catFreq %>% full_join(trnFreq[,c("catID","propUsedCol1","propUsedCol2","propUsedCol3","propUsed")],by="catID") 

   qplot(catID, propUsed,size=nTotal, data=catFreq)
```

[//]: # (corrplot: R code (No Results in Document))
```{r echo=FALSE,warning=FALSE,error=FALSE,message=FALSE,cache=TRUE,warning=FALSE,include=FALSE,comment=NA}
   #load weicheng's correlation matrix:
   #need catcor, catmat
   #setwd("../weicheng/"); source("./categoryExploration.R"); setwd("../ian/");

   #get counts of times any tow catIDs are seen together
   catmat = data.frame(cbind(splitCats[,17:21], matrix(sapply(1:nrow(splitCats), function(i) as.numeric(paste0("cat",1:31) %in% splitCats[i,17:21])),byrow=FALSE,nrow=nrow(splitCats))))
   names(catmat)[6:36] = paste0("cat",1:31)

   allFreqs = catmat %>% 
      group_by(cat1,cat2,cat3,cat4,cat5,cat6,cat7,cat8,cat9, cat10,cat11,cat12,cat13,cat14,cat15,cat16,cat17,cat18,cat19, cat20,cat21,cat22,cat23,cat24,cat25,cat26,cat27,cat28,cat29, cat30,cat31) %>%
      summarise(CategoryFreq = n()) %>%
      data.frame %>% 
      arrange(-cat1,-cat2,-cat3,-cat4,-cat5,-cat6,-cat7,-cat8,-cat9, -cat10,-cat11,-cat12,-cat13,-cat14,-cat15,-cat16,-cat17,-cat18,-cat19, -cat20,-cat21,-cat22,-cat23,-cat24,-cat25,-cat26,-cat27,-cat28,-cat29, -cat30,-cat31)

   extend.columns = function(dcats,dcnts){
      Xcats = as.matrix(dcats[,which(names(dcats) %in% paste0("cat",1:31))])
      Xcnts = as.matrix(dcnts[,which(names(dcnts) %in% paste0("cat",1:31))])
      Xmat = Xcats%*%t(Xcnts)
      resdat = cbind(dcats,data.frame(matrix(0,nrow(dcats),5)))
      names(resdat) = c(names(dcats), paste0('nTimesMatch',1:5))

      for(i in 1:nrow(dcats)){
         for(j in 1:5){
            if(length(which(Xmat[i,] == j)) > 0){
               resdat[i,(ncol(dcats)+j)] = sum(dcnts$CategoryFreq[which(Xmat[i,] == j)])
            }
         }
      }
      return(resdat)
   }

   cntsXcat = extend.columns(catmat,allFreqs)
@

[//]: # (corrplot: R code (No Results in Document))
```{r corrplot,echo=FALSE,warning=FALSE,error=FALSE,message=FALSE,cache=TRUE,warning=FALSE,include=FALSE,comment=NA}
   Xtest = data.frame(matrix(c(1,rep(0,30)),1,31))
   names(Xtest) = names(catmat)[6:36]
   extend.columns(Xtest, dcnts)
   catFreq

   pcorrmat = cor(catmat[,6:36])

   #get counts of times any two catIDs are seen together
   countMat = matrix(0,3*31,32)
   for(i in 1:3){
      for(j in 1:31){ 
         for (k in (j+1):31){ 
            row.j = (i-1)*31 + j
            countMat[row.j,k] = sum(catmat[which(catmat[,32] == i),j]*catmat[which(catmat[,32] == i),k]) 
         } 
         countMat[row.j,32] = i
      }
   }

   countData = as.data.frame(countMat)
   names(countData) = c(paste0("cat",1:31),'couponCol')
   countData$cols = rep(names(countData)[1:31],3)

   countData = countData %>% 
      gather(catID2,prop,-cols,-couponCol) %>%  
      arrange(cols,catID2) %>% 
      renm(c("couponCol","catID1","catID2","nTotal")) %>% 
      unique %>% 
      spread(couponCol,nTotal) %>%
      renm(c("catID1","catID2","nTotalCol1","nTotalCol2","nTotalCol3"))
```
We now have a matrix identifying correlation between two categories and the number of times they occur.

We can get correlation matrix and count matrix for when coupons are being used as well:
[//]: # (-label: R code (No Results in Document))
```{r echo=FALSE,warning=FALSE,error=FALSE,message=FALSE,cache=TRUE,warning=FALSE,include=FALSE,comment=NA}
   #get counts of times any tow catIDs are seen together IN THE TRAINING SET
   catmatTR = matrix(0,nrow(split.trn),32)
   for(i in 1:nrow(catmatTR)){
      catmatTR[i,1:31] = as.numeric(paste0("cat",1:31) %in% split.trn[i,16:20])
      catmatTR[i,32] = split.trn$couponCol[i]
   }

   pcorrmatTR = cor(catmatTR[,1:31])

   #get counts of times any tow catIDs are seen together IN THE TRAINING SET
   countMatTR = matrix(0,3*31,32)
   for(i in 1:3){
      for(j in 1:31){ 
         for (k in (j+1):31){ 
            row.j = (i-1)*31 + j
            countMatTR[row.j,k] = sum(catmatTR[which(catmatTR[,32] == i),j]*catmatTR[which(catmatTR[,32] == i),k]) 
         } 
         countMatTR[row.j,32] = i
      }
   }

   countDataTR = as.data.frame(countMatTR)
   names(countDataTR) = c(paste0("cat",1:31),'couponCol')
   countDataTR$cols = rep(names(countDataTR)[1:31],3)

   countDataTR = countDataTR %>% 
      gather(catID2,prop,-cols,-couponCol) %>%  
      arrange(cols,catID2) %>% 
      renm(c("couponCol","catID1","catID2","nTotal")) %>% 
      unique %>% 
      spread(couponCol,nTotal) %>%
      renm(c("catID1","catID2","nTotalCol1","nTotalCol2","nTotalCol3"))


   #do the same for when coupons are used
   splitCatsUsedTR = split.trn[which(split.trn$couponUsed == 1),]

   #get counts of times any tow catIDs are seen together IN THE UsedTRAINING SET
   catmatUsedTR = matrix(0,nrow(splitCatsUsedTR),32)
   for(i in 1:nrow(catmatUsedTR)){
      catmatUsedTR[i,1:31] = as.numeric(paste0("cat",1:31) %in% splitCatsUsedTR[i,16:20])
      catmatUsedTR[i,32] = splitCatsUsedTR$couponCol[i]
   }

   pcorrmatUsedTR = cor(catmatUsedTR[,1:31])

   #get counts of times any tow catIDs are seen together IN THE UsedTRAINING SET
   countMatUsedTR = matrix(0,3*31,32)
   for(i in 1:3){
      for(j in 1:31){ 
         for (k in (j+1):31){ 
            row.j = (i-1)*31 + j
            countMatUsedTR[row.j,k] = sum(catmatUsedTR[which(catmatUsedTR[,32] == i),j]*catmatUsedTR[which(catmatUsedTR[,32] == i),k]) 
         } 
         countMatUsedTR[row.j,32] = i
      }
   }

   countUsedData = as.data.frame(countMatUsedTR)
   names(countUsedData) = c(paste0("cat",1:31),'couponCol')
   countUsedData$cols = rep(names(countUsedData)[1:31],3)

   countUsedData = countUsedData %>% 
      gather(catID2,propUsed,-cols,-couponCol) %>%  
      arrange(cols,catID2) %>% 
      renm(c("couponCol","catID1","catID2","nUsed")) %>% 
      unique %>% 
      spread(couponCol,nUsed) %>%
      renm(c("catID1","catID2","nUsedCol1","nUsedCol2","nUsedCol3"))

   countDataTR$nTotal = with(countDataTR,nTotalCol1 + nTotalCol2 + nTotalCol3)
   countUsedData$nUsed = with(countUsedData,nUsedCol1 + nUsedCol2 + nUsedCol3)

   propTable = countDataTR %>% full_join(countUsedData,by=c("catID1","catID2"))

   propTable$propUsedCol1 = with(propTable,nUsedCol1/nTotalCol1)
   propTable$propUsedCol2 = with(propTable,nUsedCol2/nTotalCol2)
   propTable$propUsedCol3 = with(propTable,nUsedCol3/nTotalCol3)
   propTable$propUsed = with(propTable,nUsed/nTotal)

   countData$nTotal = with(countData,nTotalCol1 + nTotalCol2 + nTotalCol3)

   dogFreq = countData %>% full_join(propTable[,c("catID1","catID2","propUsedCol1", "propUsedCol2", "propUsedCol3", "propUsed")],by=c("catID1","catID2"))
   dogFreq = dogFreq %>% filter(nTotal > 0)

   qplot(catID1,catID2,color=nTotal,size=propUsed,data=dogFreq)
```

We can save this output:
[//]: # (chunk-label: R code (No Results in Document))
```{r echo=FALSE,warning=FALSE,error=FALSE,message=FALSE,cache=TRUE,warning=FALSE,include=FALSE,comment=NA}
   saveRDS(catFreq,file="../features/feature_files/one-way_categoricalProportions.rds")
   saveRDS(dogFreq,file="../features/feature_files/two-way_categoricalProportions.rds")
```
