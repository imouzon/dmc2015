


\PassOptionsToPackage{xcolor}{usenames,dvipsnames,svgnames,table}
\documentclass[10pt]{report}
\usepackage[]{graphicx}\usepackage[]{xcolor}
%% maxwidth is the original width if it is less than linewidth
%% otherwise use linewidth (to make sure the graphics do not exceed the margin)
\makeatletter
\def\maxwidth{ %
  \ifdim\Gin@nat@width>\linewidth
    \linewidth
  \else
    \Gin@nat@width
  \fi
}
\makeatother

\definecolor{fgcolor}{rgb}{0.345, 0.345, 0.345}
\newcommand{\hlnum}[1]{\textcolor[rgb]{0.686,0.059,0.569}{#1}}%
\newcommand{\hlstr}[1]{\textcolor[rgb]{0.192,0.494,0.8}{#1}}%
\newcommand{\hlcom}[1]{\textcolor[rgb]{0.678,0.584,0.686}{\textit{#1}}}%
\newcommand{\hlopt}[1]{\textcolor[rgb]{0,0,0}{#1}}%
\newcommand{\hlstd}[1]{\textcolor[rgb]{0.345,0.345,0.345}{#1}}%
\newcommand{\hlkwa}[1]{\textcolor[rgb]{0.161,0.373,0.58}{\textbf{#1}}}%
\newcommand{\hlkwb}[1]{\textcolor[rgb]{0.69,0.353,0.396}{#1}}%
\newcommand{\hlkwc}[1]{\textcolor[rgb]{0.333,0.667,0.333}{#1}}%
\newcommand{\hlkwd}[1]{\textcolor[rgb]{0.737,0.353,0.396}{\textbf{#1}}}%

\usepackage{framed}
\makeatletter
\newenvironment{kframe}{%
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother

\definecolor{shadecolor}{rgb}{.97, .97, .97}
\definecolor{messagecolor}{rgb}{0, 0, 0}
\definecolor{warningcolor}{rgb}{1, 0, 1}
\definecolor{errorcolor}{rgb}{1, 0, 0}
\newenvironment{knitrout}{}{} % an empty environment to be redefined in TeX

\usepackage{alltt}
\newcommand{\SweaveOpts}[1]{}  % do not interfere with LaTeX
\newcommand{\SweaveInput}[1]{} % because they are not real TeX commands
\newcommand{\Sexpr}[1]{}       % will only be parsed by R


\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{pdfcolmk}
\usepackage{multirow}
\usepackage{graphicx}
\usepackage{pifont}
\usepackage{amsmath,amsfonts,amsthm,amssymb}
\usepackage{setspace}
\usepackage{Tabbing}
\usepackage{etoolbox}
\usepackage{fancyhdr}
\usepackage{lastpage}
\usepackage{listings}
\usepackage{extramarks}
\usepackage{enumerate}
\usepackage{soul,color}
\usepackage{graphicx,float,wrapfig}
\usepackage{amsmath,amssymb,rotating}
\usepackage{epsfig}
\usepackage{color}
\usepackage{hyperref}
\usepackage{animate}
\usepackage{array}
\usepackage{graphics, color}
\usepackage{graphicx}
\usepackage{epsfig}
\usepackage{setspace}
\usepackage{verbatim}
\usepackage[margin=1.0in]{geometry}
\usepackage{tikz}
\usepackage{mdframed}
\usepackage{clrscode3e}
\usepackage{formalHW}
\usepackage[dmc2015,none]{formatHW}
\usepackage{fancyquote}
\usepackage{fancyenvironments}
\usepackage{mymathmacros}
\usepackage{algorithm}
\usepackage[noend]{algpseudocode}
\usepackage{pgfplots}





\begin{document}
% For LaTeX-Box: root = coupon_and_basketValue.tex 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  File Name: coupon_and_basketValue.rnw
%  Purpose:
%
%  Creation Date: 25-04-2015
%  Last Modified: Mon Apr 27 19:24:54 2015
%  Created By:
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%-- Set parent file


%-- title page and quote
\HWinfo{April 27 2015}{}{}
\titleheader

I am using the following packages:
%-- paks: R code (Code in Document)
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
   \hlkwd{library}\hlstd{(ggplot2)}
   \hlkwd{library}\hlstd{(lubridate)}
   \hlkwd{library}\hlstd{(xtable)}
   \hlkwd{library}\hlstd{(foreach)}
   \hlkwd{library}\hlstd{(rCharts)}
   \hlkwd{library}\hlstd{(magrittr)}
   \hlkwd{library}\hlstd{(tidyr)}
   \hlkwd{library}\hlstd{(dplyr)}
   \hlkwd{library}\hlstd{(reshape2)}
   \hlkwd{library}\hlstd{(gtools)}
   \hlkwd{library}\hlstd{(sqldf)}
\end{alltt}
\end{kframe}
\end{knitrout}
I am also using the simple renaming function:
%-- Name: R code (Code in Document)
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
   \hlstd{renm} \hlkwb{=} \hlkwa{function}\hlstd{(}\hlkwc{dsn}\hlstd{,}\hlkwc{colnum}\hlstd{=}\hlkwa{NULL}\hlstd{,}\hlkwc{newname}\hlstd{=}\hlkwa{NULL}\hlstd{)\{}
      \hlkwa{if}\hlstd{(}\hlkwd{is.null}\hlstd{(newname)) newname}\hlkwb{=}\hlstd{colnum; colnum}\hlkwb{=}\hlkwa{NULL}
      \hlkwa{if} \hlstd{(}\hlkwd{is.null}\hlstd{(colnum)) colnum} \hlkwb{=} \hlnum{1}\hlopt{:}\hlkwd{ncol}\hlstd{(dsn)}
      \hlkwd{names}\hlstd{(dsn)[colnum]} \hlkwb{=} \hlstd{newname}
      \hlkwd{return}\hlstd{(dsn)}
   \hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}
and my working directory is set to \verb!dmc2015/ian!.
\section{Reading the Data}
I am working from the current feature matrix:
%-- readFeatMat: R code (Code in Document)
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
   \hlstd{featMat} \hlkwb{=} \hlkwd{readRDS}\hlstd{(}\hlstr{"~/dmc2015/data/featureMatrix/featMat_v1.1.rds"}\hlstd{)}
   \hlstd{trn} \hlkwb{=} \hlstd{featMat}\hlopt{$}\hlstd{train}
   \hlstd{cls} \hlkwb{=} \hlstd{featMat}\hlopt{$}\hlstd{class}
\end{alltt}
\end{kframe}
\end{knitrout}
In case I need to reference the raw data, I will read that too:
%-- readRaw: R code (Code in Document)
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
   \hlstd{raw.trn} \hlkwb{=} \hlkwd{read.csv}\hlstd{(}\hlstr{"~/dmc2015/data/clean_data/train_simple_name.csv"}\hlstd{)}
   \hlstd{raw.cls} \hlkwb{=} \hlkwd{read.csv}\hlstd{(}\hlstr{"~/dmc2015/data/clean_data/test_simple_name.csv"}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}

\section{Working with the data}
Since we are looking at coupon by batch information, 
I am going to melt the data using my coupon melt function:
%-- meltCoupon: R code (Code in Document)
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
   \hlkwd{source}\hlstd{(}\hlstr{"./R/stackCoupons.R"}\hlstd{)}
   \hlstd{stack.res} \hlkwb{=} \hlkwd{stackCoupons}\hlstd{(trn[,}\hlnum{1}\hlopt{:}\hlnum{49}\hlstd{],cls[,}\hlnum{1}\hlopt{:}\hlnum{49}\hlstd{])}
\end{alltt}


{\ttfamily\noindent\itshape\color{messagecolor}{\#\# using the following as id:\\\#\# 	orderID,\\\#\# 	orderTime,\\\#\# 	userID,\\\#\# 	couponsReceived,\\\#\# 	basketValue,\\\#\# 	couponsReceivedDate,\\\#\# 	couponsReceivedTime,\\\#\# 	couponsReceivedDoW,\\\#\# 	couponsReceivedWeekend,\\\#\# 	couponsReceivedFriSat,\\\#\# 	orderTimeDate,\\\#\# 	orderTimeTime,\\\#\# 	orderTimeDoW,\\\#\# 	orderTimeWeekend,\\\#\# 	orderTimeFriSat,\\\#\# 	batchID,\\\#\# 	couponsExpire,\\\#\# 	couponsSent,\\\#\# 	TimeBtwnSentRec,\\\#\# 	TimeBtwnRecExpire,\\\#\# 	TimeBtwnRecOrder,\\\#\# 	TimeBtwnOrderExpire\\\#\# \\\#\# using the following as measure columns:\\\#\# 	couponID1,\\\#\# 	price1,\\\#\# 	basePrice1,\\\#\# 	reward1,\\\#\# 	premiumProduct1,\\\#\# 	brand1,\\\#\# 	productGroup1,\\\#\# 	categoryIDs1,\\\#\# 	coupon1Used,\\\#\# 	couponID2,\\\#\# 	price2,\\\#\# 	basePrice2,\\\#\# 	reward2,\\\#\# 	premiumProduct2,\\\#\# 	brand2,\\\#\# 	productGroup2,\\\#\# 	categoryIDs2,\\\#\# 	coupon2Used,\\\#\# 	couponID3,\\\#\# 	price3,\\\#\# 	basePrice3,\\\#\# 	reward3,\\\#\# 	premiumProduct3,\\\#\# 	brand3,\\\#\# 	productGroup3,\\\#\# 	categoryIDs3,\\\#\# 	coupon3Used}}\begin{alltt}
   \hlstd{bvalues} \hlkwb{=} \hlstd{stack.res}\hlopt{$}\hlstd{train} \hlopt{%>%}
      \hlkwd{select}\hlstd{(couponID,basketValue)} \hlopt{%>%}
      \hlkwd{arrange}\hlstd{(basketValue)} \hlopt{%$%}
      \hlstd{basketValue} \hlopt{%>%}
      \hlstd{unique} \hlopt{%>%}
      \hlstd{data.frame} \hlopt{%>%}
      \hlkwd{renm}\hlstd{(}\hlstr{"basketValue"}\hlstd{)}

   \hlstd{bvalues}\hlopt{$}\hlstd{bValRank} \hlkwb{=} \hlnum{1}\hlopt{:}\hlkwd{nrow}\hlstd{(bvalues)}

   \hlstd{stack.res}\hlopt{$}\hlstd{train} \hlkwb{=} \hlstd{stack.res}\hlopt{$}\hlstd{train} \hlopt{%>%} \hlkwd{left_join}\hlstd{(bvalues,}\hlkwc{by}\hlstd{=}\hlstr{'basketValue'}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}

\section{Basic Summary Stats}
%-- meanbval: R code (Code in Document)
We can get the 5-number summary stats quickly using \verb!dplyr! and this function:
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
   \hlstd{sum_stats} \hlkwb{=} \hlkwa{function}\hlstd{(}\hlkwc{dsn}\hlstd{)\{}
      \hlstd{dsn} \hlopt{%>%} \hlkwd{summarise}\hlstd{(}
         \hlkwc{min_bValXcpn} \hlstd{=} \hlkwd{min}\hlstd{(basketValue),}
         \hlkwc{q05_bValXcpn} \hlstd{=} \hlkwd{quantile}\hlstd{(basketValue,}\hlnum{.05}\hlstd{),}
         \hlkwc{q25_bValXcpn} \hlstd{=} \hlkwd{quantile}\hlstd{(basketValue,}\hlnum{.25}\hlstd{),}
         \hlkwc{mean_bValXcpn} \hlstd{=} \hlkwd{mean}\hlstd{(basketValue),}
         \hlkwc{med_bValXcpn} \hlstd{=} \hlkwd{median}\hlstd{(basketValue),}
         \hlkwc{max_bValXcpn} \hlstd{=} \hlkwd{max}\hlstd{(basketValue),}
         \hlkwc{q75_bValXcpn} \hlstd{=} \hlkwd{quantile}\hlstd{(basketValue,}\hlnum{.75}\hlstd{),}
         \hlkwc{q95_bValXcpn} \hlstd{=} \hlkwd{quantile}\hlstd{(basketValue,}\hlnum{.95}\hlstd{),}

         \hlkwc{min_bValrankXcpn} \hlstd{=} \hlkwd{min}\hlstd{(bValRank),}
         \hlkwc{mean_bValrankXcpn} \hlstd{=} \hlkwd{mean}\hlstd{(bValRank),}
         \hlkwc{max_bValrankXcpn} \hlstd{=} \hlkwd{max}\hlstd{(bValRank),}

         \hlkwc{minOrderTimeXcpn} \hlstd{=} \hlkwd{min}\hlstd{(orderTimeTime),}
         \hlkwc{meanOrderTimeXcpn} \hlstd{=} \hlkwd{mean}\hlstd{(orderTimeTime),}
         \hlkwc{medOrderTimeXcpn} \hlstd{=} \hlkwd{median}\hlstd{(orderTimeTime),}
         \hlkwc{maxOrderTimeXcpn} \hlstd{=} \hlkwd{max}\hlstd{(orderTimeTime),}

         \hlkwc{minSentRecTimeXcpn} \hlstd{=} \hlkwd{min}\hlstd{(TimeBtwnSentRec),}
         \hlkwc{meanSentRecTimeXcpn} \hlstd{=} \hlkwd{mean}\hlstd{(TimeBtwnSentRec),}
         \hlkwc{medSentRecTimeXcpn} \hlstd{=} \hlkwd{median}\hlstd{(TimeBtwnSentRec),}
         \hlkwc{maxSentRecTimeXcpn} \hlstd{=} \hlkwd{max}\hlstd{(TimeBtwnSentRec),}

         \hlkwc{minRecExpTimeXcpn} \hlstd{=} \hlkwd{min}\hlstd{(TimeBtwnRecExpire),}
         \hlkwc{meanRecExpTimeXcpn} \hlstd{=} \hlkwd{mean}\hlstd{(TimeBtwnRecExpire),}
         \hlkwc{medRecExpTimeXcpn} \hlstd{=} \hlkwd{median}\hlstd{(TimeBtwnRecExpire),}
         \hlkwc{maxRecExpTimeXcpn} \hlstd{=} \hlkwd{max}\hlstd{(TimeBtwnRecExpire),}

         \hlkwc{minRecOrderTimeXcpn} \hlstd{=} \hlkwd{min}\hlstd{(TimeBtwnRecOrder),}
         \hlkwc{meanRecOrderTimeXcpn} \hlstd{=} \hlkwd{mean}\hlstd{(TimeBtwnRecOrder),}
         \hlkwc{medRecOrderTimeXcpn} \hlstd{=} \hlkwd{median}\hlstd{(TimeBtwnRecOrder),}
         \hlkwc{maxRecOrderTimeXcpn} \hlstd{=} \hlkwd{max}\hlstd{(TimeBtwnRecOrder),}

         \hlkwc{minOrderExpTimeXcpn} \hlstd{=} \hlkwd{min}\hlstd{(TimeBtwnOrderExpire),}
         \hlkwc{meanOrderExpTimeXcpn} \hlstd{=} \hlkwd{mean}\hlstd{(TimeBtwnOrderExpire),}
         \hlkwc{medOrderExpTimeXcpn} \hlstd{=} \hlkwd{median}\hlstd{(TimeBtwnOrderExpire),}
         \hlkwc{maxOrderExpTimeXcpn} \hlstd{=} \hlkwd{max}\hlstd{(TimeBtwnOrderExpire))}
   \hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}

I can store stats in statXcoupon
%-- getStats: R code (Code in Document)
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
   \hlstd{statXcoupon} \hlkwb{=} \hlstd{stack.res}\hlopt{$}\hlstd{train} \hlopt{%>%}
      \hlkwd{group_by}\hlstd{(couponID)} \hlopt{%>%}
      \hlstd{sum_stats}
\end{alltt}
\end{kframe}
\end{knitrout}
And we can get the same statistics for coupons being used and coupons not being used:
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
   \hlstd{statXcoupon} \hlkwb{=} \hlstd{stack.res}\hlopt{$}\hlstd{train} \hlopt{%>%}
        \hlkwd{group_by}\hlstd{(couponID,couponUsed)} \hlopt{%>%}
        \hlstd{sum_stats} \hlopt{%>%}
        \hlkwd{gather}\hlstd{(couponID,couponUsed)} \hlopt{%>%}
        \hlkwd{renm}\hlstd{(}\hlkwd{c}\hlstd{(}\hlstr{"couponID"}\hlstd{,}\hlstr{"couponUsed"}\hlstd{,}\hlstr{"var"}\hlstd{,}\hlstr{"value"}\hlstd{))} \hlopt{%>%}
        \hlkwd{group_by}\hlstd{(couponID,value)} \hlopt{%>%}
        \hlkwd{summarise}\hlstd{(}\hlkwc{varname} \hlstd{=} \hlkwd{paste}\hlstd{(var,couponUsed,}\hlkwc{sep}\hlstd{=}\hlstr{".used"}\hlstd{))} \hlopt{%>%}
        \hlkwd{select}\hlstd{(}\hlopt{-}\hlstd{couponID)} \hlopt{%>%}
        \hlkwd{spread}\hlstd{(varname,value)} \hlopt{%>%}
        \hlkwd{left_join}\hlstd{(statXcoupon,}\hlkwc{by}\hlstd{=}\hlstr{"couponID"}\hlstd{)} \hlopt{%>%}
        \hlkwd{arrange}\hlstd{(couponID)}
\end{alltt}
\end{kframe}
\end{knitrout}

We can save these results:
%-- : R code (Code in Document)
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
   \hlstd{trn} \hlkwb{=} \hlstd{stack.res}\hlopt{$}\hlstd{train} \hlopt{%>%} \hlkwd{left_join}\hlstd{(statXcoupon,} \hlkwc{by}\hlstd{=}\hlstr{"couponID"}\hlstd{)} \hlopt{%>%} \hlstd{as.data.frame}
   \hlstd{trn} \hlkwb{=} \hlstd{trn[,}\hlkwd{c}\hlstd{(}\hlstr{"orderID"}\hlstd{,}\hlkwd{names}\hlstd{(statXcoupon))]}
   \hlkwd{saveRDS}\hlstd{(trn,}\hlkwc{file}\hlstd{=}\hlstr{"../features/feature_files/coupon_basket_stats_train.rds"}\hlstd{)}
   \hlkwd{write.csv}\hlstd{(trn,}\hlkwc{file}\hlstd{=}\hlstr{"../features/feature_files/coupon_basket_stats_train.csv"}\hlstd{,}\hlkwc{quote}\hlstd{=}\hlnum{FALSE}\hlstd{,}\hlkwc{na}\hlstd{=}\hlstr{""}\hlstd{,}\hlkwc{row.names}\hlstd{=}\hlnum{FALSE}\hlstd{)}

   \hlstd{cls} \hlkwb{=} \hlstd{stack.res}\hlopt{$}\hlstd{test} \hlopt{%>%} \hlkwd{left_join}\hlstd{(statXcoupon,} \hlkwc{by}\hlstd{=}\hlstr{"couponID"}\hlstd{)} \hlopt{%>%} \hlstd{as.data.frame}
   \hlstd{cls} \hlkwb{=} \hlstd{cls[,}\hlkwd{c}\hlstd{(}\hlstr{"orderID"}\hlstd{,}\hlkwd{names}\hlstd{(statXcoupon))]}
   \hlkwd{saveRDS}\hlstd{(cls,}\hlkwc{file}\hlstd{=}\hlstr{"../features/feature_files/coupon_basket_stats_class.rds"}\hlstd{)}
   \hlkwd{write.csv}\hlstd{(cls,}\hlkwc{file}\hlstd{=}\hlstr{"../features/feature_files/coupon_basket_stats_class.csv"}\hlstd{,}\hlkwc{quote}\hlstd{=}\hlnum{FALSE}\hlstd{,}\hlkwc{na}\hlstd{=}\hlstr{""}\hlstd{,}\hlkwc{row.names}\hlstd{=}\hlnum{FALSE}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}



\end{document}
