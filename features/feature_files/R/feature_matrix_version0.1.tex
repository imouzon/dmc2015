\PassOptionsToPackage{xcolor}{usenames,dvipsnames,svgnames,table}
\documentclass[10pt]{report}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{pdfcolmk}
\usepackage{multirow}
\usepackage{graphicx}
\usepackage{pifont}
\usepackage{amsmath,amsfonts,amsthm,amssymb}
\usepackage{setspace}
\usepackage{Tabbing}
\usepackage{etoolbox}
\usepackage{fancyhdr}
\usepackage{lastpage}
\usepackage{listings}
\usepackage{extramarks}
\usepackage{enumerate}
\usepackage{soul,color}
\usepackage{graphicx,float,wrapfig}
\usepackage{amsmath,amssymb,rotating}
\usepackage{epsfig}
\usepackage{color}
\usepackage{hyperref}
\usepackage{animate}
\usepackage{array}
\usepackage{graphics, color}
\usepackage{graphicx}
\usepackage{epsfig}
\usepackage{setspace}
\usepackage{verbatim}
\usepackage[margin=1.0in]{geometry}
\usepackage{tikz}
\usepackage{mdframed}
\usepackage{clrscode3e}
\usepackage{formalHW}
\usepackage[none,DMC]{formatHW}
\usepackage{fancyquote}
\usepackage{fancyenvironments}
\usepackage{mymathmacros}
\usepackage{algorithm}
\usepackage[noend]{algpseudocode}
\usepackage{pgfplots}

%set up fancy page header
\pagestyle{fancy}
   \chead{DMC@ISU:\ Feature Matrix v. 0.1}  
   \rhead{\firstxmark}
   \lfoot{\lastxmark}
   \cfoot{}
   \rfoot{Page\ \thepage\ of\ \pageref{LastPage}}
   \renewcommand\headrulewidth{0.4pt}
   \renewcommand\footrulewidth{0.4pt}

% pandoc syntax highlighting
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\newenvironment{Shaded}{}{}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{{#1}}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{{#1}}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{{#1}}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{{#1}}}
\newcommand{\RegionMarkerTok}[1]{{#1}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
\newcommand{\NormalTok}[1]{{#1}}

% header includes

\begin{document}

\thispagestyle{empty}%
\begin{center}%
    \renewcommand{\arraystretch}{1.5}%
    \begin{tabular}{c}%
       \Large{DMC@ISU: The 2015 Iowa State University Data Mining Cup Team}\\
       Creating Feature Matrix Version 0.1\\
       Spring 2015, A Team as Strong as Steel \\
    \end{tabular}
\end{center}

\begin{center}
 \renewcommand{\arraystretch}{1.5}
 \begin{tabular*}{0.65\textwidth}{r@{:\hspace{.3cm}}l}
    \hline
    
    
    Last Day&  May 19, 2015\\
    \hline
 \end{tabular*}
\end{center}

I am using the following packages:

\begin{Shaded}
\begin{Highlighting}[]
   \KeywordTok{library}\NormalTok{(magrittr)}
   \KeywordTok{library}\NormalTok{(dplyr)}
   \KeywordTok{library}\NormalTok{(tidyr)}
   \KeywordTok{library}\NormalTok{(lubridate)}
   \KeywordTok{library}\NormalTok{(ggplot2)}
   \KeywordTok{library}\NormalTok{(rCharts)}
   \KeywordTok{library}\NormalTok{(xtable)}
   \KeywordTok{library}\NormalTok{(foreach)}
   \KeywordTok{library}\NormalTok{(gtools)}
   \KeywordTok{library}\NormalTok{(knitr)}
   \KeywordTok{library}\NormalTok{(utils)}
   \KeywordTok{source}\NormalTok{(}\StringTok{"~/dmc2015/ian/R/renm.R"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\section{I am cleaning the original
features}\label{i-am-cleaning-the-original-features}

There are some things that I realized last night:

\begin{itemize}
\item
  \verb!sim_ftd! and \verb!sim_lnorm! are identical. They are just
  scaled versions of the same thing and we can drop them.
\item
  We missed several files, either by their location or structure being
  problematic.
\item
  We would all feel more comfortable if the orderIDs are on the data.
\end{itemize}

So I am recreating the feature matrices:

\subsection{Universal Features}\label{universal-features}

These are the files that I know contain universal features:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{path.to.files =}\StringTok{ "../universal/individual/"}
\NormalTok{files =}\StringTok{ }\KeywordTok{list.files}\NormalTok{(path.to.files)}
\KeywordTok{cat}\NormalTok{(}\KeywordTok{paste}\NormalTok{(files, }\DataTypeTok{collapse =} \StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## basePrice_price_ratio.rds
## basePrice_price_ratio2.rds
## ftd_invmax_similarity.rds
## ftd_ivf_similarity.rds
## ftd_lnorm_similarity.rds
## ftd_pif_similarity.rds
## item_price_basePrice_reward_long.rds
## item_price_basePrice_reward_wide.rds
## jaccard_similarity.rds
## lnorm_invmax_similarity.rds
## lnorm_ivf_similarity.rds
## lnorm_lnorm_similarity.rds
## lnorm_pif_similarity.rds
## order_match_class.rds
## peteCoupFreq.rds
## user_info.rds
## userTimeFeatures.rds
\end{verbatim}

We can read each in as follows:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{files =}\StringTok{ }\KeywordTok{list.files}\NormalTok{(}\StringTok{"~/dmc2015/features/feature_files/universal/individual/"}\NormalTok{, }
    \DataTypeTok{full.name =} \OtherTok{TRUE}\NormalTok{)}
\NormalTok{features =}\StringTok{ }\KeywordTok{lapply}\NormalTok{(files, function(x) }\KeywordTok{readRDS}\NormalTok{(x))}
\end{Highlighting}
\end{Shaded}

Keep in mind that long files have 20,166 rows and wide files have 6722
rows. Wide files should have columns identified as \verb!couponCol!:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{wideSet =}\StringTok{ }\KeywordTok{c}\NormalTok{()}
\NormalTok{longSet =}\StringTok{ }\KeywordTok{c}\NormalTok{()}
\NormalTok{noSet =}\StringTok{ }\KeywordTok{c}\NormalTok{()}
\NormalTok{for (i in }\DecValTok{1}\NormalTok{:}\KeywordTok{length}\NormalTok{(features)) \{}
    \NormalTok{if (}\KeywordTok{nrow}\NormalTok{(features[[i]]) ==}\StringTok{ }\DecValTok{20166}\NormalTok{) \{}
        \NormalTok{longSet =}\StringTok{ }\KeywordTok{c}\NormalTok{(longSet, i)}
    \NormalTok{\} else \{}
        \NormalTok{if (}\KeywordTok{nrow}\NormalTok{(features[[i]]) ==}\StringTok{ }\DecValTok{6722}\NormalTok{) \{}
            \NormalTok{wideSet =}\StringTok{ }\KeywordTok{c}\NormalTok{(wideSet, i)}
        \NormalTok{\} else \{}
            \NormalTok{noSet =}\StringTok{ }\KeywordTok{c}\NormalTok{(noSet, i)}
        \NormalTok{\}}
    \NormalTok{\}}
\NormalTok{\}}

\NormalTok{## wide format sets:}
\NormalTok{wideSet}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1]  2  3  4  5  6  8  9 10 11 12 13 14 15 16 17
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{## long format sets:}
\NormalTok{longSet}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 7
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{## no format sets:}
\NormalTok{noSet}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## NULL
\end{verbatim}

in this case, only the second set
/Users/user/dmc2015/features/feature\_files/universal/individual//basePrice\_price\_ratio.rds,
/Users/user/dmc2015/features/feature\_files/universal/individual//item\_price\_basePrice\_reward\_long.rds
is long, and it is kind of broken:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{badlong =}\StringTok{ }\KeywordTok{grep}\NormalTok{(}\StringTok{"basePrice_price_ratio.rds"}\NormalTok{, files)}
\NormalTok{features[[badlong]] %>%}\StringTok{ }\NormalTok{head}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   orderID bPr2pr_ratio1 bPr2pr_ratio2 bPr2pr_ratio3 bPr2pr_approx_ratio1
## 1       1     1.6666667            NA            NA                  1.7
## 2       1            NA     0.1098266            NA                   NA
## 3       1            NA            NA    1.00000000                   NA
## 4       2     0.6853448            NA            NA                  0.7
## 5       2            NA     0.5000000            NA                   NA
## 6       2            NA            NA    0.01542416                   NA
##   bPr2pr_approx_ratio2 bPr2pr_approx_ratio3
## 1                   NA                   NA
## 2                  0.1                   NA
## 3                   NA                    1
## 4                   NA                   NA
## 5                  0.5                   NA
## 6                   NA                    0
\end{verbatim}

so I will just convert the long format.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{features[[badlong]] =}\StringTok{ }\NormalTok{features[[badlong]] %>%}\StringTok{ }\KeywordTok{gather}\NormalTok{(columnName, value, -orderID) %>%}\StringTok{ }
\StringTok{    }\KeywordTok{filter}\NormalTok{(!}\KeywordTok{is.na}\NormalTok{(value)) %>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{varName =} \KeywordTok{gsub}\NormalTok{(}\StringTok{"ratio[0-9]"}\NormalTok{, }\StringTok{"ratio"}\NormalTok{, columnName)) %>%}\StringTok{ }
\StringTok{    }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{couponCol =} \DecValTok{1} \NormalTok{*}\StringTok{ }\KeywordTok{grepl}\NormalTok{(}\StringTok{"ratio1"}\NormalTok{, columnName) +}\StringTok{ }\DecValTok{2} \NormalTok{*}\StringTok{ }\KeywordTok{grepl}\NormalTok{(}\StringTok{"ratio2"}\NormalTok{, }
        \NormalTok{columnName) +}\StringTok{ }\DecValTok{3} \NormalTok{*}\StringTok{ }\KeywordTok{grepl}\NormalTok{(}\StringTok{"ratio3"}\NormalTok{, columnName)) %>%}\StringTok{ }\KeywordTok{select}\NormalTok{(-columnName) %>%}\StringTok{ }
\StringTok{    }\KeywordTok{spread}\NormalTok{(varName, value) %>%}\StringTok{ }\KeywordTok{arrange}\NormalTok{(orderID, couponCol)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Combine Wide Sets:}\label{combine-wide-sets}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{wideFrame =}\StringTok{ }\NormalTok{features[[wideSet[}\DecValTok{1}\NormalTok{]]] %>%}\StringTok{ }\KeywordTok{select}\NormalTok{(orderID)}
\NormalTok{for (x in wideSet) \{}
    \NormalTok{dsn.i =}\StringTok{ }\NormalTok{features[[x]]}
    \NormalTok{dropCols =}\StringTok{ }\KeywordTok{which}\NormalTok{(}\KeywordTok{names}\NormalTok{(dsn.i) %in%}\StringTok{ }\KeywordTok{names}\NormalTok{(wideFrame) &}\StringTok{ }\KeywordTok{names}\NormalTok{(dsn.i) !=}\StringTok{ "orderID"}\NormalTok{)}
    \NormalTok{if (}\KeywordTok{length}\NormalTok{(dropCols) ==}\StringTok{ }\DecValTok{0}\NormalTok{) \{}
        \NormalTok{wideFrame =}\StringTok{ }\NormalTok{wideFrame %>%}\StringTok{ }\KeywordTok{left_join}\NormalTok{(dsn.i, }\DataTypeTok{by =} \StringTok{"orderID"}\NormalTok{)}
    \NormalTok{\} else \{}
        \NormalTok{wideFrame =}\StringTok{ }\NormalTok{wideFrame %>%}\StringTok{ }\KeywordTok{left_join}\NormalTok{(dsn.i[, -dropCols], }\DataTypeTok{by =} \StringTok{"orderID"}\NormalTok{)}
    \NormalTok{\}}
\NormalTok{\}}
\KeywordTok{names}\NormalTok{(wideFrame) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"cos}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{.sim"}\NormalTok{, }\StringTok{"cosSim"}\NormalTok{, }\KeywordTok{names}\NormalTok{(wideFrame))}
\KeywordTok{names}\NormalTok{(wideFrame) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"([np])Coup(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d)(Col}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d)"}\NormalTok{, }\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{1times}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{3_}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{2"}\NormalTok{, }\KeywordTok{names}\NormalTok{(wideFrame))}
\KeywordTok{names}\NormalTok{(wideFrame) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"(^.*[^_0-9])(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d+)$"}\NormalTok{, }\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{1_}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{2"}\NormalTok{, }\KeywordTok{names}\NormalTok{(wideFrame))}
\NormalTok{wideFrame =}\StringTok{ }\NormalTok{wideFrame[, }\KeywordTok{which}\NormalTok{(!}\KeywordTok{grepl}\NormalTok{(}\StringTok{"sim_lnorm_.*_"}\NormalTok{, }\KeywordTok{names}\NormalTok{(wideFrame)))]}
\end{Highlighting}
\end{Shaded}

\subsubsection{Long Version}\label{long-version}

We can also convert this set to the long format. Notice that not all of
the files are the same ``wide'' as others, but we would still like to
use them:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{coln =}\StringTok{ }\KeywordTok{names}\NormalTok{(wideFrame)}
\NormalTok{non_numbered_cols =}\StringTok{ }\KeywordTok{which}\NormalTok{(!}\KeywordTok{grepl}\NormalTok{(}\StringTok{"_}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d+$"}\NormalTok{, coln))}
\NormalTok{coupon1_cols =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{grep}\NormalTok{(}\StringTok{"_(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)1(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)$"}\NormalTok{, coln))}
\NormalTok{coupon2_cols =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{grep}\NormalTok{(}\StringTok{"_(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)2(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)$"}\NormalTok{, coln))}
\NormalTok{coupon3_cols =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{grep}\NormalTok{(}\StringTok{"_(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)3(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)$"}\NormalTok{, coln))}

\NormalTok{## coupon 1}
\NormalTok{coupon1 =}\StringTok{ }\NormalTok{wideFrame[, coupon1_cols]}
\KeywordTok{names}\NormalTok{(coupon1) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_13$"}\NormalTok{, }\StringTok{"_to3Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon1))}
\KeywordTok{names}\NormalTok{(coupon1) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_12$"}\NormalTok{, }\StringTok{"_to2Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon1))}
\KeywordTok{names}\NormalTok{(coupon1) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_1$"}\NormalTok{, }\StringTok{""}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon1))}
\NormalTok{coupon1$couponCol =}\StringTok{ }\DecValTok{1}

\NormalTok{## coupon 2}
\NormalTok{coupon2 =}\StringTok{ }\NormalTok{wideFrame[, coupon2_cols]}
\KeywordTok{names}\NormalTok{(coupon2) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_23$"}\NormalTok{, }\StringTok{"_to3Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon2))}
\KeywordTok{names}\NormalTok{(coupon2) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_12$"}\NormalTok{, }\StringTok{"_to1Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon2))}
\KeywordTok{names}\NormalTok{(coupon2) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_2$"}\NormalTok{, }\StringTok{""}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon2))}
\NormalTok{coupon2$couponCol =}\StringTok{ }\DecValTok{2}

\NormalTok{## coupon 3}
\NormalTok{coupon3 =}\StringTok{ }\NormalTok{wideFrame[, coupon3_cols]}
\KeywordTok{names}\NormalTok{(coupon3) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_23$"}\NormalTok{, }\StringTok{"_to2Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon3))}
\KeywordTok{names}\NormalTok{(coupon3) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_13$"}\NormalTok{, }\StringTok{"_to3Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon3))}
\KeywordTok{names}\NormalTok{(coupon3) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_3$"}\NormalTok{, }\StringTok{""}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon3))}
\NormalTok{coupon3$couponCol =}\StringTok{ }\DecValTok{3}

\NormalTok{coupons =}\StringTok{ }\KeywordTok{bind_rows}\NormalTok{(coupon1, coupon2, coupon3)}
\NormalTok{for (i in }\KeywordTok{grep}\NormalTok{(}\StringTok{"_to}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{dCol"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupons))) }\KeywordTok{is.na}\NormalTok{(coupons[, i]) =}\StringTok{ }\DecValTok{1}

\NormalTok{longFrame =}\StringTok{ }\NormalTok{wideFrame[, non_numbered_cols] %>%}\StringTok{ }\KeywordTok{left_join}\NormalTok{(coupons, }\DataTypeTok{by =} \StringTok{"orderID"}\NormalTok{) %>%}\StringTok{ }
\StringTok{    }\KeywordTok{arrange}\NormalTok{(orderID, couponCol)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Check Universal Features}\label{check-universal-features}

We can check the final results:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{dim}\NormalTok{(wideFrame)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 6722  172
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{dim}\NormalTok{(longFrame)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 20166   101
\end{verbatim}

\subsubsection{Save Universal}\label{save-universal}

These are our universal features:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{saveRDS}\NormalTok{(wideFrame, }\DataTypeTok{file =} \StringTok{"../universal/combined/universalFeaturesCombined_wide.rds"}\NormalTok{)}
\KeywordTok{saveRDS}\NormalTok{(longFrame, }\DataTypeTok{file =} \StringTok{"../universal/combined/universalFeaturesCombined_long.rds"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\section{Feature Matrix for Set 1}\label{feature-matrix-for-set-1}

Again we need to read in the files. In addition to the \verb!llrs! we
have:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{path.to.files =}\StringTok{ "../set1/individual/"}
\NormalTok{files =}\StringTok{ }\KeywordTok{list.files}\NormalTok{(path.to.files, }\DataTypeTok{full.name =} \OtherTok{TRUE}\NormalTok{)}
\KeywordTok{cat}\NormalTok{(}\KeywordTok{paste}\NormalTok{(files, }\DataTypeTok{collapse =} \StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## ../set1/individual//clean_coupon_used_wide.rds
## ../set1/individual//HTVmelt1_Combn_UniqueUser.rds
## ../set1/individual//llrs
\end{verbatim}

We repeat the process of creating the wide set and then the long set: We
can read each in as follows:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{path.to.files =}\StringTok{ "../set1/individual/"}
\NormalTok{path.to.llrs =}\StringTok{ "../set1/individual/llrs/"}
\NormalTok{files =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\KeywordTok{list.files}\NormalTok{(path.to.files, }\DataTypeTok{pattern =} \StringTok{".rds"}\NormalTok{, }\DataTypeTok{full.name =} \OtherTok{TRUE}\NormalTok{), }\KeywordTok{list.files}\NormalTok{(path.to.llrs, }
    \DataTypeTok{pattern =} \StringTok{"wide"}\NormalTok{, }\DataTypeTok{full.name =} \OtherTok{TRUE}\NormalTok{))}
\NormalTok{features =}\StringTok{ }\KeywordTok{lapply}\NormalTok{(files, function(x) }\KeywordTok{readRDS}\NormalTok{(x))}

\CommentTok{# make one set of adjustments}
\NormalTok{features[[}\DecValTok{2}\NormalTok{]] =}\StringTok{ }\KeywordTok{do.call}\NormalTok{(}\StringTok{"rbind"}\NormalTok{, features[[}\DecValTok{2}\NormalTok{]])}
\end{Highlighting}
\end{Shaded}

Keep in mind that long files have 20,166 rows and wide files have 6722
rows. Wide files should have columns identified as \verb!couponCol!:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{wideSet =}\StringTok{ }\KeywordTok{c}\NormalTok{()}
\NormalTok{longSet =}\StringTok{ }\KeywordTok{c}\NormalTok{()}
\NormalTok{noSet =}\StringTok{ }\KeywordTok{c}\NormalTok{()}
\NormalTok{for (i in }\DecValTok{1}\NormalTok{:}\KeywordTok{length}\NormalTok{(features)) \{}
    \NormalTok{if (}\KeywordTok{nrow}\NormalTok{(features[[i]]) ==}\StringTok{ }\DecValTok{20166}\NormalTok{) \{}
        \NormalTok{longSet =}\StringTok{ }\KeywordTok{c}\NormalTok{(longSet, i)}
    \NormalTok{\} else \{}
        \NormalTok{if (}\KeywordTok{nrow}\NormalTok{(features[[i]]) ==}\StringTok{ }\DecValTok{6722}\NormalTok{) \{}
            \NormalTok{wideSet =}\StringTok{ }\KeywordTok{c}\NormalTok{(wideSet, i)}
        \NormalTok{\} else \{}
            \NormalTok{noSet =}\StringTok{ }\KeywordTok{c}\NormalTok{(noSet, i)}
        \NormalTok{\}}
    \NormalTok{\}}
\NormalTok{\}}

\NormalTok{## wide format sets:}
\NormalTok{wideSet}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   [1]   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19
##  [18]  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36
##  [35]  37  38  39  40  41  42  43  44  45  46  47  48  49  50  51  52  53
##  [52]  54  55  56  57  58  59  60  61  62  63  64  65  66  67  68  69  70
##  [69]  71  72  73  74  75  76  77  78  79  80  81  82  83  84  85  86  87
##  [86]  88  89  90  91  92  93  94  95  96  97  98  99 100 101 102 103 104
## [103] 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121
## [120] 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138
## [137] 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155
## [154] 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172
## [171] 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189
## [188] 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206
## [205] 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223
## [222] 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240
## [239] 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257
## [256] 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274
## [273] 275 276 277 278
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{## long format sets:}
\NormalTok{longSet}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## NULL
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{## no format sets:}
\NormalTok{noSet}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 2
\end{verbatim}

in this case, sets ../set1/individual//clean\_coupon\_used\_wide.rds,
../set1/individual//HTVmelt1\_Combn\_UniqueUser.rds have no proper
place. We can figure out why this is by doing the following:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{features[[noSet[}\DecValTok{1}\NormalTok{]]] %>%}\StringTok{ }\NormalTok{names}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "orderID"        "nCoupon1Used"   "pCoupon1Used"   "nCoup1Col1Used"
##  [5] "nCoup1Col2Used" "nCoup1Col3Used" "pCoup1Col1Used" "pCoup1Col2Used"
##  [9] "pCoup1Col3Used" "pCoupon1in1"    "nCoupon2Used"   "pCoupon2Used"  
## [13] "nCoup2Col1Used" "nCoup2Col2Used" "nCoup2Col3Used" "pCoup2Col1Used"
## [17] "pCoup2Col2Used" "pCoup2Col3Used" "pCoupon2in2"    "nCoupon3Used"  
## [21] "pCoupon3Used"   "nCoup3Col1Used" "nCoup3Col2Used" "nCoup3Col3Used"
## [25] "pCoup3Col1Used" "pCoup3Col2Used" "pCoup3Col3Used" "pCoupon3in3"
\end{verbatim}

The first set appears to be wide and should join well. All of the
\verb!NA!s would be in the historical rows and wouldn't make their way
to our feature matrix.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{features[[noSet[}\DecValTok{2}\NormalTok{]]] %>%}\StringTok{ }\NormalTok{names}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   [1] "orderID"                                            
##   [2] "orderTime"                                          
##   [3] "userID"                                             
##   [4] "couponsReceived"                                    
##   [5] "basketValue"                                        
##   [6] "couponsReceivedDate"                                
##   [7] "couponsReceivedTime"                                
##   [8] "couponsReceivedDoW"                                 
##   [9] "couponsReceivedWeekend"                             
##  [10] "couponsReceivedFriSat"                              
##  [11] "orderTimeDate"                                      
##  [12] "orderTimeTime"                                      
##  [13] "orderTimeDoW"                                       
##  [14] "orderTimeWeekend"                                   
##  [15] "orderTimeFriSat"                                    
##  [16] "batchID"                                            
##  [17] "couponsExpire"                                      
##  [18] "couponsSent"                                        
##  [19] "TimeBtwnSentRec"                                    
##  [20] "TimeBtwnRecExpire"                                  
##  [21] "TimeBtwnRecOrder"                                   
##  [22] "TimeBtwnOrderExpire"                                
##  [23] "couponID"                                           
##  [24] "price"                                              
##  [25] "basePrice"                                          
##  [26] "reward"                                             
##  [27] "premiumProduct"                                     
##  [28] "brand"                                              
##  [29] "productGroup"                                       
##  [30] "categoryIDs"                                        
##  [31] "couponUsed"                                         
##  [32] "couponCol"                                          
##  [33] "TimeBtwnRecOrder_disc"                              
##  [34] "ratio_bp_p"                                         
##  [35] "ratio_bp_p_round"                                   
##  [36] "couponID_nUser"                                     
##  [37] "couponID_nUserUsed"                                 
##  [38] "couponID_Twice"                                     
##  [39] "couponID_prob"                                      
##  [40] "couponsReceivedTime_nUser"                          
##  [41] "couponsReceivedTime_nUserUsed"                      
##  [42] "couponsReceivedTime_Twice"                          
##  [43] "couponsReceivedTime_prob"                           
##  [44] "couponsReceivedDoW_nUser"                           
##  [45] "couponsReceivedDoW_nUserUsed"                       
##  [46] "couponsReceivedDoW_prob"                            
##  [47] "orderTimeTime_nUser"                                
##  [48] "orderTimeTime_nUserUsed"                            
##  [49] "orderTimeTime_Twice"                                
##  [50] "orderTimeTime_prob"                                 
##  [51] "orderTimeDoW_nUser"                                 
##  [52] "orderTimeDoW_nUserUsed"                             
##  [53] "orderTimeDoW_prob"                                  
##  [54] "TimeBtwnRecOrder_disc_nUser"                        
##  [55] "TimeBtwnRecOrder_disc_nUserUsed"                    
##  [56] "TimeBtwnRecOrder_disc_Twice"                        
##  [57] "TimeBtwnRecOrder_disc_prob"                         
##  [58] "price_nUser"                                        
##  [59] "price_nUserUsed"                                    
##  [60] "price_Twice"                                        
##  [61] "price_prob"                                         
##  [62] "basePrice_nUser"                                    
##  [63] "basePrice_nUserUsed"                                
##  [64] "basePrice_Twice"                                    
##  [65] "basePrice_prob"                                     
##  [66] "productGroup_nUser"                                 
##  [67] "productGroup_nUserUsed"                             
##  [68] "productGroup_Twice"                                 
##  [69] "productGroup_prob"                                  
##  [70] "categoryIDs_nUser"                                  
##  [71] "categoryIDs_nUserUsed"                              
##  [72] "categoryIDs_Twice"                                  
##  [73] "categoryIDs_prob"                                   
##  [74] "ratio_bp_p_round_nUser"                             
##  [75] "ratio_bp_p_round_nUserUsed"                         
##  [76] "ratio_bp_p_round_Twice"                             
##  [77] "ratio_bp_p_round_prob"                              
##  [78] "reward_couponsReceivedTime_nUser"                   
##  [79] "reward_couponsReceivedTime_nUserUsed"               
##  [80] "reward_couponsReceivedTime_Twice"                   
##  [81] "reward_couponsReceivedTime_prob"                    
##  [82] "reward_couponsReceivedDoW_nUser"                    
##  [83] "reward_couponsReceivedDoW_nUserUsed"                
##  [84] "reward_couponsReceivedDoW_Twice"                    
##  [85] "reward_couponsReceivedDoW_prob"                     
##  [86] "reward_orderTimeTime_nUser"                         
##  [87] "reward_orderTimeTime_nUserUsed"                     
##  [88] "reward_orderTimeTime_Twice"                         
##  [89] "reward_orderTimeTime_prob"                          
##  [90] "reward_orderTimeDoW_nUser"                          
##  [91] "reward_orderTimeDoW_nUserUsed"                      
##  [92] "reward_orderTimeDoW_Twice"                          
##  [93] "reward_orderTimeDoW_prob"                           
##  [94] "reward_TimeBtwnRecOrder_disc_nUser"                 
##  [95] "reward_TimeBtwnRecOrder_disc_nUserUsed"             
##  [96] "reward_TimeBtwnRecOrder_disc_Twice"                 
##  [97] "reward_TimeBtwnRecOrder_disc_prob"                  
##  [98] "reward_price_nUser"                                 
##  [99] "reward_price_nUserUsed"                             
## [100] "reward_price_Twice"                                 
## [101] "reward_price_prob"                                  
## [102] "reward_basePrice_nUser"                             
## [103] "reward_basePrice_nUserUsed"                         
## [104] "reward_basePrice_Twice"                             
## [105] "reward_basePrice_prob"                              
## [106] "reward_productGroup_nUser"                          
## [107] "reward_productGroup_nUserUsed"                      
## [108] "reward_productGroup_Twice"                          
## [109] "reward_productGroup_prob"                           
## [110] "reward_categoryIDs_nUser"                           
## [111] "reward_categoryIDs_nUserUsed"                       
## [112] "reward_categoryIDs_Twice"                           
## [113] "reward_categoryIDs_prob"                            
## [114] "reward_ratio_bp_p_round_nUser"                      
## [115] "reward_ratio_bp_p_round_nUserUsed"                  
## [116] "reward_ratio_bp_p_round_Twice"                      
## [117] "reward_ratio_bp_p_round_prob"                       
## [118] "reward_brand_nUser"                                 
## [119] "reward_brand_nUserUsed"                             
## [120] "reward_brand_Twice"                                 
## [121] "reward_brand_prob"                                  
## [122] "reward_premiumProduct_nUser"                        
## [123] "reward_premiumProduct_nUserUsed"                    
## [124] "reward_premiumProduct_Twice"                        
## [125] "reward_premiumProduct_prob"                         
## [126] "couponID_couponsReceivedTime_nUserUsed"             
## [127] "couponID_couponsReceivedTime_Twice"                 
## [128] "couponID_couponsReceivedTime_prob"                  
## [129] "couponID_couponsReceivedDoW_nUser"                  
## [130] "couponID_couponsReceivedDoW_nUserUsed"              
## [131] "couponID_couponsReceivedDoW_Twice"                  
## [132] "couponID_couponsReceivedDoW_prob"                   
## [133] "couponID_orderTimeTime_nUserUsed"                   
## [134] "couponID_orderTimeTime_prob"                        
## [135] "couponID_orderTimeDoW_nUser"                        
## [136] "couponID_orderTimeDoW_nUserUsed"                    
## [137] "couponID_orderTimeDoW_Twice"                        
## [138] "couponID_orderTimeDoW_prob"                         
## [139] "couponID_TimeBtwnRecOrder_disc_nUser"               
## [140] "couponID_TimeBtwnRecOrder_disc_nUserUsed"           
## [141] "couponID_TimeBtwnRecOrder_disc_Twice"               
## [142] "couponID_TimeBtwnRecOrder_disc_prob"                
## [143] "couponsReceivedTime_couponsReceivedDoW_nUser"       
## [144] "couponsReceivedTime_couponsReceivedDoW_nUserUsed"   
## [145] "couponsReceivedTime_couponsReceivedDoW_Twice"       
## [146] "couponsReceivedTime_couponsReceivedDoW_prob"        
## [147] "couponsReceivedTime_orderTimeTime_nUserUsed"        
## [148] "couponsReceivedTime_orderTimeTime_Twice"            
## [149] "couponsReceivedTime_orderTimeTime_prob"             
## [150] "couponsReceivedTime_orderTimeDoW_nUser"             
## [151] "couponsReceivedTime_orderTimeDoW_nUserUsed"         
## [152] "couponsReceivedTime_orderTimeDoW_Twice"             
## [153] "couponsReceivedTime_orderTimeDoW_prob"              
## [154] "couponsReceivedTime_TimeBtwnRecOrder_disc_nUser"    
## [155] "couponsReceivedTime_TimeBtwnRecOrder_disc_nUserUsed"
## [156] "couponsReceivedTime_TimeBtwnRecOrder_disc_Twice"    
## [157] "couponsReceivedTime_TimeBtwnRecOrder_disc_prob"     
## [158] "couponsReceivedTime_price_nUser"                    
## [159] "couponsReceivedTime_price_nUserUsed"                
## [160] "couponsReceivedTime_price_Twice"                    
## [161] "couponsReceivedTime_price_prob"                     
## [162] "couponsReceivedTime_basePrice_nUser"                
## [163] "couponsReceivedTime_basePrice_nUserUsed"            
## [164] "couponsReceivedTime_basePrice_Twice"                
## [165] "couponsReceivedTime_basePrice_prob"                 
## [166] "couponsReceivedTime_productGroup_nUser"             
## [167] "couponsReceivedTime_productGroup_nUserUsed"         
## [168] "couponsReceivedTime_productGroup_Twice"             
## [169] "couponsReceivedTime_productGroup_prob"              
## [170] "couponsReceivedTime_categoryIDs_nUser"              
## [171] "couponsReceivedTime_categoryIDs_nUserUsed"          
## [172] "couponsReceivedTime_categoryIDs_Twice"              
## [173] "couponsReceivedTime_categoryIDs_prob"               
## [174] "couponsReceivedTime_ratio_bp_p_round_nUser"         
## [175] "couponsReceivedTime_ratio_bp_p_round_nUserUsed"     
## [176] "couponsReceivedTime_ratio_bp_p_round_Twice"         
## [177] "couponsReceivedTime_ratio_bp_p_round_prob"          
## [178] "couponsReceivedTime_brand_nUser"                    
## [179] "couponsReceivedTime_brand_nUserUsed"                
## [180] "couponsReceivedTime_brand_Twice"                    
## [181] "couponsReceivedTime_brand_prob"                     
## [182] "couponsReceivedTime_premiumProduct_nUser"           
## [183] "couponsReceivedTime_premiumProduct_nUserUsed"       
## [184] "couponsReceivedTime_premiumProduct_Twice"           
## [185] "couponsReceivedTime_premiumProduct_prob"            
## [186] "couponsReceivedDoW_orderTimeTime_nUser"             
## [187] "couponsReceivedDoW_orderTimeTime_nUserUsed"         
## [188] "couponsReceivedDoW_orderTimeTime_Twice"             
## [189] "couponsReceivedDoW_orderTimeTime_prob"              
## [190] "couponsReceivedDoW_orderTimeDoW_nUser"              
## [191] "couponsReceivedDoW_orderTimeDoW_nUserUsed"          
## [192] "couponsReceivedDoW_orderTimeDoW_Twice"              
## [193] "couponsReceivedDoW_orderTimeDoW_prob"               
## [194] "couponsReceivedDoW_TimeBtwnRecOrder_disc_nUser"     
## [195] "couponsReceivedDoW_TimeBtwnRecOrder_disc_nUserUsed" 
## [196] "couponsReceivedDoW_TimeBtwnRecOrder_disc_Twice"     
## [197] "couponsReceivedDoW_TimeBtwnRecOrder_disc_prob"      
## [198] "couponsReceivedDoW_price_nUser"                     
## [199] "couponsReceivedDoW_price_nUserUsed"                 
## [200] "couponsReceivedDoW_price_Twice"                     
## [201] "couponsReceivedDoW_price_prob"                      
## [202] "couponsReceivedDoW_basePrice_nUser"                 
## [203] "couponsReceivedDoW_basePrice_nUserUsed"             
## [204] "couponsReceivedDoW_basePrice_Twice"                 
## [205] "couponsReceivedDoW_basePrice_prob"                  
## [206] "couponsReceivedDoW_productGroup_nUser"              
## [207] "couponsReceivedDoW_productGroup_nUserUsed"          
## [208] "couponsReceivedDoW_productGroup_Twice"              
## [209] "couponsReceivedDoW_productGroup_prob"               
## [210] "couponsReceivedDoW_categoryIDs_nUser"               
## [211] "couponsReceivedDoW_categoryIDs_nUserUsed"           
## [212] "couponsReceivedDoW_categoryIDs_Twice"               
## [213] "couponsReceivedDoW_categoryIDs_prob"                
## [214] "couponsReceivedDoW_ratio_bp_p_round_nUser"          
## [215] "couponsReceivedDoW_ratio_bp_p_round_nUserUsed"      
## [216] "couponsReceivedDoW_ratio_bp_p_round_Twice"          
## [217] "couponsReceivedDoW_ratio_bp_p_round_prob"           
## [218] "couponsReceivedDoW_brand_nUser"                     
## [219] "couponsReceivedDoW_brand_nUserUsed"                 
## [220] "couponsReceivedDoW_brand_Twice"                     
## [221] "couponsReceivedDoW_brand_prob"                      
## [222] "couponsReceivedDoW_premiumProduct_nUser"            
## [223] "couponsReceivedDoW_premiumProduct_nUserUsed"        
## [224] "couponsReceivedDoW_premiumProduct_prob"             
## [225] "orderTimeTime_orderTimeDoW_nUser"                   
## [226] "orderTimeTime_orderTimeDoW_nUserUsed"               
## [227] "orderTimeTime_orderTimeDoW_Twice"                   
## [228] "orderTimeTime_orderTimeDoW_prob"                    
## [229] "orderTimeTime_TimeBtwnRecOrder_disc_nUser"          
## [230] "orderTimeTime_TimeBtwnRecOrder_disc_nUserUsed"      
## [231] "orderTimeTime_TimeBtwnRecOrder_disc_Twice"          
## [232] "orderTimeTime_TimeBtwnRecOrder_disc_prob"           
## [233] "orderTimeTime_price_nUser"                          
## [234] "orderTimeTime_price_nUserUsed"                      
## [235] "orderTimeTime_price_Twice"                          
## [236] "orderTimeTime_price_prob"                           
## [237] "orderTimeTime_basePrice_nUser"                      
## [238] "orderTimeTime_basePrice_nUserUsed"                  
## [239] "orderTimeTime_basePrice_Twice"                      
## [240] "orderTimeTime_basePrice_prob"                       
## [241] "orderTimeTime_productGroup_nUser"                   
## [242] "orderTimeTime_productGroup_nUserUsed"               
## [243] "orderTimeTime_productGroup_Twice"                   
## [244] "orderTimeTime_productGroup_prob"                    
## [245] "orderTimeTime_categoryIDs_nUser"                    
## [246] "orderTimeTime_categoryIDs_nUserUsed"                
## [247] "orderTimeTime_categoryIDs_Twice"                    
## [248] "orderTimeTime_categoryIDs_prob"                     
## [249] "orderTimeTime_ratio_bp_p_round_nUser"               
## [250] "orderTimeTime_ratio_bp_p_round_nUserUsed"           
## [251] "orderTimeTime_ratio_bp_p_round_Twice"               
## [252] "orderTimeTime_ratio_bp_p_round_prob"                
## [253] "orderTimeTime_brand_nUser"                          
## [254] "orderTimeTime_brand_nUserUsed"                      
## [255] "orderTimeTime_brand_Twice"                          
## [256] "orderTimeTime_brand_prob"                           
## [257] "orderTimeTime_premiumProduct_nUser"                 
## [258] "orderTimeTime_premiumProduct_nUserUsed"             
## [259] "orderTimeTime_premiumProduct_Twice"                 
## [260] "orderTimeTime_premiumProduct_prob"                  
## [261] "orderTimeDoW_TimeBtwnRecOrder_disc_nUser"           
## [262] "orderTimeDoW_TimeBtwnRecOrder_disc_nUserUsed"       
## [263] "orderTimeDoW_TimeBtwnRecOrder_disc_Twice"           
## [264] "orderTimeDoW_TimeBtwnRecOrder_disc_prob"            
## [265] "orderTimeDoW_price_nUser"                           
## [266] "orderTimeDoW_price_nUserUsed"                       
## [267] "orderTimeDoW_price_Twice"                           
## [268] "orderTimeDoW_price_prob"                            
## [269] "orderTimeDoW_basePrice_nUser"                       
## [270] "orderTimeDoW_basePrice_nUserUsed"                   
## [271] "orderTimeDoW_basePrice_Twice"                       
## [272] "orderTimeDoW_basePrice_prob"                        
## [273] "orderTimeDoW_productGroup_nUser"                    
## [274] "orderTimeDoW_productGroup_nUserUsed"                
## [275] "orderTimeDoW_productGroup_Twice"                    
## [276] "orderTimeDoW_productGroup_prob"                     
## [277] "orderTimeDoW_categoryIDs_nUser"                     
## [278] "orderTimeDoW_categoryIDs_nUserUsed"                 
## [279] "orderTimeDoW_categoryIDs_Twice"                     
## [280] "orderTimeDoW_categoryIDs_prob"                      
## [281] "orderTimeDoW_ratio_bp_p_round_nUser"                
## [282] "orderTimeDoW_ratio_bp_p_round_nUserUsed"            
## [283] "orderTimeDoW_ratio_bp_p_round_Twice"                
## [284] "orderTimeDoW_ratio_bp_p_round_prob"                 
## [285] "orderTimeDoW_brand_nUser"                           
## [286] "orderTimeDoW_brand_nUserUsed"                       
## [287] "orderTimeDoW_brand_Twice"                           
## [288] "orderTimeDoW_brand_prob"                            
## [289] "orderTimeDoW_premiumProduct_nUser"                  
## [290] "orderTimeDoW_premiumProduct_nUserUsed"              
## [291] "orderTimeDoW_premiumProduct_prob"                   
## [292] "TimeBtwnRecOrder_disc_price_nUser"                  
## [293] "TimeBtwnRecOrder_disc_price_nUserUsed"              
## [294] "TimeBtwnRecOrder_disc_price_Twice"                  
## [295] "TimeBtwnRecOrder_disc_price_prob"                   
## [296] "TimeBtwnRecOrder_disc_basePrice_nUser"              
## [297] "TimeBtwnRecOrder_disc_basePrice_nUserUsed"          
## [298] "TimeBtwnRecOrder_disc_basePrice_Twice"              
## [299] "TimeBtwnRecOrder_disc_basePrice_prob"               
## [300] "TimeBtwnRecOrder_disc_productGroup_nUser"           
## [301] "TimeBtwnRecOrder_disc_productGroup_nUserUsed"       
## [302] "TimeBtwnRecOrder_disc_productGroup_Twice"           
## [303] "TimeBtwnRecOrder_disc_productGroup_prob"            
## [304] "TimeBtwnRecOrder_disc_categoryIDs_nUser"            
## [305] "TimeBtwnRecOrder_disc_categoryIDs_nUserUsed"        
## [306] "TimeBtwnRecOrder_disc_categoryIDs_Twice"            
## [307] "TimeBtwnRecOrder_disc_categoryIDs_prob"             
## [308] "TimeBtwnRecOrder_disc_ratio_bp_p_round_nUser"       
## [309] "TimeBtwnRecOrder_disc_ratio_bp_p_round_nUserUsed"   
## [310] "TimeBtwnRecOrder_disc_ratio_bp_p_round_Twice"       
## [311] "TimeBtwnRecOrder_disc_ratio_bp_p_round_prob"        
## [312] "TimeBtwnRecOrder_disc_brand_nUser"                  
## [313] "TimeBtwnRecOrder_disc_brand_nUserUsed"              
## [314] "TimeBtwnRecOrder_disc_brand_Twice"                  
## [315] "TimeBtwnRecOrder_disc_brand_prob"                   
## [316] "TimeBtwnRecOrder_disc_premiumProduct_nUser"         
## [317] "TimeBtwnRecOrder_disc_premiumProduct_nUserUsed"     
## [318] "TimeBtwnRecOrder_disc_premiumProduct_Twice"         
## [319] "TimeBtwnRecOrder_disc_premiumProduct_prob"          
## [320] "price_basePrice_nUser"                              
## [321] "price_basePrice_nUserUsed"                          
## [322] "price_basePrice_Twice"                              
## [323] "price_basePrice_prob"                               
## [324] "price_productGroup_nUser"                           
## [325] "price_productGroup_nUserUsed"                       
## [326] "price_productGroup_Twice"                           
## [327] "price_productGroup_prob"                            
## [328] "price_categoryIDs_nUser"                            
## [329] "price_categoryIDs_nUserUsed"                        
## [330] "price_categoryIDs_Twice"                            
## [331] "price_categoryIDs_prob"                             
## [332] "price_ratio_bp_p_round_nUser"                       
## [333] "price_ratio_bp_p_round_nUserUsed"                   
## [334] "price_ratio_bp_p_round_Twice"                       
## [335] "price_ratio_bp_p_round_prob"                        
## [336] "price_brand_nUser"                                  
## [337] "price_brand_nUserUsed"                              
## [338] "price_brand_Twice"                                  
## [339] "price_brand_prob"                                   
## [340] "price_premiumProduct_nUser"                         
## [341] "price_premiumProduct_nUserUsed"                     
## [342] "price_premiumProduct_Twice"                         
## [343] "price_premiumProduct_prob"                          
## [344] "basePrice_productGroup_nUser"                       
## [345] "basePrice_productGroup_nUserUsed"                   
## [346] "basePrice_productGroup_Twice"                       
## [347] "basePrice_productGroup_prob"                        
## [348] "basePrice_categoryIDs_nUser"                        
## [349] "basePrice_categoryIDs_nUserUsed"                    
## [350] "basePrice_categoryIDs_Twice"                        
## [351] "basePrice_categoryIDs_prob"                         
## [352] "basePrice_ratio_bp_p_round_nUser"                   
## [353] "basePrice_ratio_bp_p_round_nUserUsed"               
## [354] "basePrice_ratio_bp_p_round_Twice"                   
## [355] "basePrice_ratio_bp_p_round_prob"                    
## [356] "basePrice_brand_nUser"                              
## [357] "basePrice_brand_nUserUsed"                          
## [358] "basePrice_brand_Twice"                              
## [359] "basePrice_brand_prob"                               
## [360] "basePrice_premiumProduct_nUser"                     
## [361] "basePrice_premiumProduct_nUserUsed"                 
## [362] "basePrice_premiumProduct_Twice"                     
## [363] "basePrice_premiumProduct_prob"                      
## [364] "productGroup_categoryIDs_nUser"                     
## [365] "productGroup_categoryIDs_nUserUsed"                 
## [366] "productGroup_categoryIDs_Twice"                     
## [367] "productGroup_categoryIDs_prob"                      
## [368] "productGroup_ratio_bp_p_round_nUser"                
## [369] "productGroup_ratio_bp_p_round_nUserUsed"            
## [370] "productGroup_ratio_bp_p_round_Twice"                
## [371] "productGroup_ratio_bp_p_round_prob"                 
## [372] "productGroup_brand_nUser"                           
## [373] "productGroup_brand_nUserUsed"                       
## [374] "productGroup_brand_Twice"                           
## [375] "productGroup_brand_prob"                            
## [376] "productGroup_premiumProduct_nUser"                  
## [377] "productGroup_premiumProduct_nUserUsed"              
## [378] "productGroup_premiumProduct_Twice"                  
## [379] "productGroup_premiumProduct_prob"                   
## [380] "categoryIDs_ratio_bp_p_round_nUser"                 
## [381] "categoryIDs_ratio_bp_p_round_nUserUsed"             
## [382] "categoryIDs_ratio_bp_p_round_Twice"                 
## [383] "categoryIDs_ratio_bp_p_round_prob"                  
## [384] "categoryIDs_brand_nUser"                            
## [385] "categoryIDs_brand_nUserUsed"                        
## [386] "categoryIDs_brand_Twice"                            
## [387] "categoryIDs_brand_prob"                             
## [388] "categoryIDs_premiumProduct_nUser"                   
## [389] "categoryIDs_premiumProduct_nUserUsed"               
## [390] "categoryIDs_premiumProduct_Twice"                   
## [391] "categoryIDs_premiumProduct_prob"                    
## [392] "ratio_bp_p_round_brand_nUser"                       
## [393] "ratio_bp_p_round_brand_nUserUsed"                   
## [394] "ratio_bp_p_round_brand_Twice"                       
## [395] "ratio_bp_p_round_brand_prob"                        
## [396] "ratio_bp_p_round_premiumProduct_nUser"              
## [397] "ratio_bp_p_round_premiumProduct_nUserUsed"          
## [398] "ratio_bp_p_round_premiumProduct_Twice"              
## [399] "ratio_bp_p_round_premiumProduct_prob"               
## [400] "brand_premiumProduct_nUser"                         
## [401] "brand_premiumProduct_nUserUsed"                     
## [402] "brand_premiumProduct_Twice"                         
## [403] "brand_premiumProduct_prob"
\end{verbatim}

The second set appears to be long, so I will just convert the long
format.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{badlong =}\StringTok{ }\NormalTok{noSet[}\DecValTok{2}\NormalTok{]}
\NormalTok{features[[badlong]] =}\StringTok{ }\NormalTok{features[[badlong]][, -(}\DecValTok{2}\NormalTok{:}\DecValTok{31}\NormalTok{)] %>%}\StringTok{ }\KeywordTok{gather}\NormalTok{(columnName, }
    \NormalTok{value, -orderID, -couponCol) %>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{varName =} \KeywordTok{paste0}\NormalTok{(columnName, }\StringTok{"_"}\NormalTok{, }
    \NormalTok{couponCol)) %>%}\StringTok{ }\KeywordTok{select}\NormalTok{(orderID, varName, value) %>%}\StringTok{ }\KeywordTok{spread}\NormalTok{(varName, value) %>%}\StringTok{ }
\StringTok{    }\KeywordTok{arrange}\NormalTok{(orderID)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Combine Wide Sets:}\label{combine-wide-sets-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{wideFrame =}\StringTok{ }\NormalTok{features[[badlong]]}
\NormalTok{for (x in wideSet) \{}
    \NormalTok{dsn.i =}\StringTok{ }\NormalTok{features[[x]]}
    \NormalTok{dropCols =}\StringTok{ }\KeywordTok{which}\NormalTok{(}\KeywordTok{names}\NormalTok{(dsn.i) %in%}\StringTok{ }\KeywordTok{names}\NormalTok{(wideFrame) &}\StringTok{ }\KeywordTok{names}\NormalTok{(dsn.i) !=}\StringTok{ "orderID"}\NormalTok{)}
    \NormalTok{if (}\KeywordTok{length}\NormalTok{(dropCols) ==}\StringTok{ }\DecValTok{0}\NormalTok{) \{}
        \NormalTok{wideFrame =}\StringTok{ }\NormalTok{wideFrame %>%}\StringTok{ }\KeywordTok{full_join}\NormalTok{(dsn.i, }\DataTypeTok{by =} \StringTok{"orderID"}\NormalTok{)}
    \NormalTok{\} else \{}
        \NormalTok{wideFrame =}\StringTok{ }\NormalTok{wideFrame %>%}\StringTok{ }\KeywordTok{full_join}\NormalTok{(dsn.i[, -dropCols], }\DataTypeTok{by =} \StringTok{"orderID"}\NormalTok{)}
    \NormalTok{\}}
\NormalTok{\}}
\KeywordTok{names}\NormalTok{(wideFrame) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_[Cc]ol(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d+)$"}\NormalTok{, }\StringTok{"_}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{1"}\NormalTok{, }\KeywordTok{names}\NormalTok{(wideFrame))}
\KeywordTok{names}\NormalTok{(wideFrame) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"(^.*[^_0-9])(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d+)$"}\NormalTok{, }\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{1_}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{2"}\NormalTok{, }\KeywordTok{names}\NormalTok{(wideFrame))}
\NormalTok{wideFrame =}\StringTok{ }\NormalTok{wideFrame[, }\KeywordTok{which}\NormalTok{(!}\KeywordTok{grepl}\NormalTok{(}\StringTok{"times(N*o*t*)Used*_"}\NormalTok{, }\KeywordTok{names}\NormalTok{(wideFrame)))]}
\end{Highlighting}
\end{Shaded}

\subsubsection{Long Version}\label{long-version-1}

We can also convert this set to the long format. Notice that not all of
the files are the same ``wide'' as others, but we would still like to
use them:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{coln =}\StringTok{ }\KeywordTok{names}\NormalTok{(wideFrame)}
\NormalTok{non_numbered_cols =}\StringTok{ }\KeywordTok{which}\NormalTok{(!}\KeywordTok{grepl}\NormalTok{(}\StringTok{"_}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d+$"}\NormalTok{, coln))}
\NormalTok{coupon1_cols =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{grep}\NormalTok{(}\StringTok{"_(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)1(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)$"}\NormalTok{, coln))}
\NormalTok{coupon2_cols =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{grep}\NormalTok{(}\StringTok{"_(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)2(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)$"}\NormalTok{, coln))}
\NormalTok{coupon3_cols =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{grep}\NormalTok{(}\StringTok{"_(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)3(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)$"}\NormalTok{, coln))}

\NormalTok{## coupon 1}
\NormalTok{coupon1 =}\StringTok{ }\NormalTok{wideFrame[, coupon1_cols]}
\KeywordTok{names}\NormalTok{(coupon1) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_13$"}\NormalTok{, }\StringTok{"_to3Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon1))}
\KeywordTok{names}\NormalTok{(coupon1) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_12$"}\NormalTok{, }\StringTok{"_to2Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon1))}
\KeywordTok{names}\NormalTok{(coupon1) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_1$"}\NormalTok{, }\StringTok{""}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon1))}
\NormalTok{coupon1$couponCol =}\StringTok{ }\DecValTok{1}

\NormalTok{## coupon 2}
\NormalTok{coupon2 =}\StringTok{ }\NormalTok{wideFrame[, coupon2_cols]}
\KeywordTok{names}\NormalTok{(coupon2) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_23$"}\NormalTok{, }\StringTok{"_to3Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon2))}
\KeywordTok{names}\NormalTok{(coupon2) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_12$"}\NormalTok{, }\StringTok{"_to1Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon2))}
\KeywordTok{names}\NormalTok{(coupon2) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_2$"}\NormalTok{, }\StringTok{""}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon2))}
\NormalTok{coupon2$couponCol =}\StringTok{ }\DecValTok{2}

\NormalTok{## coupon 3}
\NormalTok{coupon3 =}\StringTok{ }\NormalTok{wideFrame[, coupon3_cols]}
\KeywordTok{names}\NormalTok{(coupon3) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_23$"}\NormalTok{, }\StringTok{"_to2Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon3))}
\KeywordTok{names}\NormalTok{(coupon3) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_13$"}\NormalTok{, }\StringTok{"_to3Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon3))}
\KeywordTok{names}\NormalTok{(coupon3) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_3$"}\NormalTok{, }\StringTok{""}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon3))}
\NormalTok{coupon3$couponCol =}\StringTok{ }\DecValTok{3}

\NormalTok{coupons =}\StringTok{ }\KeywordTok{bind_rows}\NormalTok{(coupon1, coupon2, coupon3)}

\NormalTok{longFrame =}\StringTok{ }\NormalTok{coupons %>%}\StringTok{ }\KeywordTok{arrange}\NormalTok{(orderID, couponCol)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Check Universal
Features}\label{check-universal-features-1}

We can check the final results:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{dim}\NormalTok{(wideFrame)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 6722 3598
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{dim}\NormalTok{(longFrame)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 20166  1201
\end{verbatim}

\subsubsection{Save Universal}\label{save-universal-1}

These are our universal features:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{saveRDS}\NormalTok{(wideFrame, }\DataTypeTok{file =} \StringTok{"../set1/combined/set1FeaturesCombined_wide.rds"}\NormalTok{)}
\KeywordTok{saveRDS}\NormalTok{(longFrame, }\DataTypeTok{file =} \StringTok{"../set1/combined/set1FeaturesCombined_long.rds"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\section{Feature Matrix for Set 2}\label{feature-matrix-for-set-2}

Again we need to read in the files. In addition to the \verb!llrs! we
have:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{path.to.files =}\StringTok{ "../set2/individual/"}
\NormalTok{files =}\StringTok{ }\KeywordTok{list.files}\NormalTok{(path.to.files, }\DataTypeTok{full.name =} \OtherTok{TRUE}\NormalTok{)}
\KeywordTok{cat}\NormalTok{(}\KeywordTok{paste}\NormalTok{(files, }\DataTypeTok{collapse =} \StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## ../set2/individual//coupon_usr_info.rds
## ../set2/individual//HTVmelt2_Combn_UniqueUser.rds
## ../set2/individual//llrs
\end{verbatim}

We repeat the process of creating the wide set and then the long set: We
can read each in as follows:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{path.to.files =}\StringTok{ "../set2/individual/"}
\NormalTok{path.to.llrs =}\StringTok{ "../set2/individual/llrs/"}
\NormalTok{files =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\KeywordTok{list.files}\NormalTok{(path.to.files, }\DataTypeTok{pattern =} \StringTok{".rds"}\NormalTok{, }\DataTypeTok{full.name =} \OtherTok{TRUE}\NormalTok{), }\KeywordTok{list.files}\NormalTok{(path.to.llrs, }
    \DataTypeTok{pattern =} \StringTok{"wide"}\NormalTok{, }\DataTypeTok{full.name =} \OtherTok{TRUE}\NormalTok{))}
\NormalTok{features =}\StringTok{ }\KeywordTok{lapply}\NormalTok{(files, function(x) }\KeywordTok{readRDS}\NormalTok{(x))}

\CommentTok{# make one set of adjustments}
\NormalTok{features[[}\DecValTok{2}\NormalTok{]] =}\StringTok{ }\KeywordTok{do.call}\NormalTok{(}\StringTok{"rbind"}\NormalTok{, features[[}\DecValTok{2}\NormalTok{]])}
\end{Highlighting}
\end{Shaded}

Keep in mind that long files have 20,166 rows and wide files have 6722
rows. Wide files should have columns identified as \verb!couponCol!:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{wideSet =}\StringTok{ }\KeywordTok{c}\NormalTok{()}
\NormalTok{longSet =}\StringTok{ }\KeywordTok{c}\NormalTok{()}
\NormalTok{noSet =}\StringTok{ }\KeywordTok{c}\NormalTok{()}
\NormalTok{for (i in }\DecValTok{1}\NormalTok{:}\KeywordTok{length}\NormalTok{(features)) \{}
    \NormalTok{if (}\KeywordTok{nrow}\NormalTok{(features[[i]]) ==}\StringTok{ }\DecValTok{20166}\NormalTok{) \{}
        \NormalTok{longSet =}\StringTok{ }\KeywordTok{c}\NormalTok{(longSet, i)}
    \NormalTok{\} else \{}
        \NormalTok{if (}\KeywordTok{nrow}\NormalTok{(features[[i]]) ==}\StringTok{ }\DecValTok{6722}\NormalTok{) \{}
            \NormalTok{wideSet =}\StringTok{ }\KeywordTok{c}\NormalTok{(wideSet, i)}
        \NormalTok{\} else \{}
            \NormalTok{noSet =}\StringTok{ }\KeywordTok{c}\NormalTok{(noSet, i)}
        \NormalTok{\}}
    \NormalTok{\}}
\NormalTok{\}}

\NormalTok{## wide format sets:}
\NormalTok{wideSet}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   [1]   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19
##  [18]  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36
##  [35]  37  38  39  40  41  42  43  44  45  46  47  48  49  50  51  52  53
##  [52]  54  55  56  57  58  59  60  61  62  63  64  65  66  67  68  69  70
##  [69]  71  72  73  74  75  76  77  78  79  80  81  82  83  84  85  86  87
##  [86]  88  89  90  91  92  93  94  95  96  97  98  99 100 101 102 103 104
## [103] 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121
## [120] 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138
## [137] 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155
## [154] 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172
## [171] 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189
## [188] 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206
## [205] 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223
## [222] 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240
## [239] 241 242
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{## long format sets:}
\NormalTok{longSet}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## NULL
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{## no format sets:}
\NormalTok{noSet}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 2
\end{verbatim}

in this case, sets ../set2/individual//coupon\_usr\_info.rds,
../set2/individual//HTVmelt2\_Combn\_UniqueUser.rds have no proper
place. We can figure out why this is by doing the following:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{features[[noSet[}\DecValTok{1}\NormalTok{]]] %>%}\StringTok{ }\NormalTok{names}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "couponID"  "nUserSent" "nUserUsed" "UsedTwice" "prop"      "prob"
\end{verbatim}

The first set appears to be long. We can join by couponID:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{features[[noSet[}\DecValTok{1}\NormalTok{]]] =}\StringTok{ }\NormalTok{features[[noSet[}\DecValTok{2}\NormalTok{]]][, -}\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{:}\DecValTok{22}\NormalTok{, }\DecValTok{24}\NormalTok{:}\DecValTok{31}\NormalTok{)] %>%}\StringTok{ }\KeywordTok{arrange}\NormalTok{(orderID, }
    \NormalTok{couponCol) %>%}\StringTok{ }\KeywordTok{left_join}\NormalTok{(features[[noSet[}\DecValTok{1}\NormalTok{]]], }\DataTypeTok{by =} \StringTok{"couponID"}\NormalTok{) %>%}\StringTok{ }\KeywordTok{select}\NormalTok{(-couponID) %>%}\StringTok{ }
\StringTok{    }\KeywordTok{gather}\NormalTok{(varname, value, -couponCol, -orderID) %>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{colname =} \KeywordTok{paste0}\NormalTok{(varname, }
    \StringTok{"_"}\NormalTok{, couponCol)) %>%}\StringTok{ }\KeywordTok{select}\NormalTok{(orderID, colname, value) %>%}\StringTok{ }\KeywordTok{spread}\NormalTok{(colname, }
    \NormalTok{value)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{features[[noSet[}\DecValTok{1}\NormalTok{]]] %>%}\StringTok{ }\KeywordTok{arrange}\NormalTok{(orderID) %>%}\StringTok{ }\KeywordTok{select}\NormalTok{(orderID) %>%}\StringTok{ }\NormalTok{head}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   orderID
## 1       1
## 2       2
## 3       3
## 4       4
## 5       5
## 6       6
\end{verbatim}

\subsubsection{Combine Wide Sets:}\label{combine-wide-sets-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{wideFrame =}\StringTok{ }\NormalTok{features[[noSet[}\DecValTok{1}\NormalTok{]]]}
\NormalTok{for (x in wideSet) \{}
    \NormalTok{dsn.i =}\StringTok{ }\NormalTok{features[[x]]}
    \NormalTok{dropCols =}\StringTok{ }\KeywordTok{which}\NormalTok{(}\KeywordTok{names}\NormalTok{(dsn.i) %in%}\StringTok{ }\KeywordTok{names}\NormalTok{(wideFrame) &}\StringTok{ }\KeywordTok{names}\NormalTok{(dsn.i) !=}\StringTok{ "orderID"}\NormalTok{)}
    \NormalTok{dropCols =}\StringTok{ }\KeywordTok{c}\NormalTok{(dropCols, }\KeywordTok{which}\NormalTok{(}\KeywordTok{grepl}\NormalTok{(}\StringTok{"times(N*o*t*)Used*_"}\NormalTok{, }\KeywordTok{names}\NormalTok{(dsn.i))))}
    \NormalTok{if (}\KeywordTok{length}\NormalTok{(dropCols) ==}\StringTok{ }\DecValTok{0}\NormalTok{) \{}
        \NormalTok{wideFrame =}\StringTok{ }\NormalTok{wideFrame %>%}\StringTok{ }\KeywordTok{full_join}\NormalTok{(dsn.i, }\DataTypeTok{by =} \StringTok{"orderID"}\NormalTok{)}
    \NormalTok{\} else \{}
        \NormalTok{wideFrame =}\StringTok{ }\NormalTok{wideFrame %>%}\StringTok{ }\KeywordTok{full_join}\NormalTok{(dsn.i[, -dropCols], }\DataTypeTok{by =} \StringTok{"orderID"}\NormalTok{)}
    \NormalTok{\}}
\NormalTok{\}}
\KeywordTok{names}\NormalTok{(wideFrame) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_[Cc]ol(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d+)$"}\NormalTok{, }\StringTok{"_}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{1"}\NormalTok{, }\KeywordTok{names}\NormalTok{(wideFrame))}
\KeywordTok{names}\NormalTok{(wideFrame) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"(^.*[^_0-9])(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d+)$"}\NormalTok{, }\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{1_}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{2"}\NormalTok{, }\KeywordTok{names}\NormalTok{(wideFrame))}
\NormalTok{wideFrame =}\StringTok{ }\NormalTok{wideFrame[, }\KeywordTok{which}\NormalTok{(!}\KeywordTok{grepl}\NormalTok{(}\StringTok{"times(N*o*t*)Used*_"}\NormalTok{, }\KeywordTok{names}\NormalTok{(wideFrame)))]}
\end{Highlighting}
\end{Shaded}

\subsubsection{Long Version}\label{long-version-2}

We can also convert this set to the long format. Notice that not all of
the files are the same ``wide'' as others, but we would still like to
use them:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{coln =}\StringTok{ }\KeywordTok{names}\NormalTok{(wideFrame)}
\NormalTok{non_numbered_cols =}\StringTok{ }\KeywordTok{which}\NormalTok{(!}\KeywordTok{grepl}\NormalTok{(}\StringTok{"_}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d+$"}\NormalTok{, coln))}
\NormalTok{coupon1_cols =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{grep}\NormalTok{(}\StringTok{"_(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)1(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)$"}\NormalTok{, coln))}
\NormalTok{coupon2_cols =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{grep}\NormalTok{(}\StringTok{"_(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)2(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)$"}\NormalTok{, coln))}
\NormalTok{coupon3_cols =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{grep}\NormalTok{(}\StringTok{"_(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)3(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)$"}\NormalTok{, coln))}

\NormalTok{## coupon 1}
\NormalTok{coupon1 =}\StringTok{ }\NormalTok{wideFrame[, coupon1_cols]}
\KeywordTok{names}\NormalTok{(coupon1) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_13$"}\NormalTok{, }\StringTok{"_to3Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon1))}
\KeywordTok{names}\NormalTok{(coupon1) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_12$"}\NormalTok{, }\StringTok{"_to2Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon1))}
\KeywordTok{names}\NormalTok{(coupon1) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_1$"}\NormalTok{, }\StringTok{""}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon1))}
\NormalTok{coupon1$couponCol =}\StringTok{ }\DecValTok{1}

\NormalTok{## coupon 2}
\NormalTok{coupon2 =}\StringTok{ }\NormalTok{wideFrame[, coupon2_cols]}
\KeywordTok{names}\NormalTok{(coupon2) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_23$"}\NormalTok{, }\StringTok{"_to3Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon2))}
\KeywordTok{names}\NormalTok{(coupon2) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_12$"}\NormalTok{, }\StringTok{"_to1Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon2))}
\KeywordTok{names}\NormalTok{(coupon2) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_2$"}\NormalTok{, }\StringTok{""}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon2))}
\NormalTok{coupon2$couponCol =}\StringTok{ }\DecValTok{2}

\NormalTok{## coupon 3}
\NormalTok{coupon3 =}\StringTok{ }\NormalTok{wideFrame[, coupon3_cols]}
\KeywordTok{names}\NormalTok{(coupon3) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_23$"}\NormalTok{, }\StringTok{"_to2Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon3))}
\KeywordTok{names}\NormalTok{(coupon3) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_13$"}\NormalTok{, }\StringTok{"_to3Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon3))}
\KeywordTok{names}\NormalTok{(coupon3) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_3$"}\NormalTok{, }\StringTok{""}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon3))}
\NormalTok{coupon3$couponCol =}\StringTok{ }\DecValTok{3}

\NormalTok{coupons =}\StringTok{ }\KeywordTok{bind_rows}\NormalTok{(coupon1, coupon2, coupon3)}

\NormalTok{longFrame =}\StringTok{ }\NormalTok{coupons %>%}\StringTok{ }\KeywordTok{arrange}\NormalTok{(orderID, couponCol)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Check Universal
Features}\label{check-universal-features-2}

We can check the final results:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{dim}\NormalTok{(wideFrame)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 6722 3286
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{dim}\NormalTok{(longFrame)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 20166  1097
\end{verbatim}

\subsubsection{Save Universal}\label{save-universal-2}

These are our universal features:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{saveRDS}\NormalTok{(wideFrame, }\DataTypeTok{file =} \StringTok{"../set2/combined/set2FeaturesCombined_wide.rds"}\NormalTok{)}
\KeywordTok{saveRDS}\NormalTok{(longFrame, }\DataTypeTok{file =} \StringTok{"../set2/combined/set2FeaturesCombined_long.rds"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\section{Feature Matrix for Set 3}\label{feature-matrix-for-set-3}

Again we need to read in the files. In addition to the \verb!llrs! we
have:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{path.to.files =}\StringTok{ "../set3/individual/"}
\NormalTok{files =}\StringTok{ }\KeywordTok{list.files}\NormalTok{(path.to.files, }\DataTypeTok{full.name =} \OtherTok{TRUE}\NormalTok{)}
\KeywordTok{cat}\NormalTok{(}\KeywordTok{paste}\NormalTok{(files, }\DataTypeTok{collapse =} \StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## ../set3/individual//HTVmelt3_Combn_UniqueUser.rds
## ../set3/individual//llrs
\end{verbatim}

We repeat the process of creating the wide set and then the long set: We
can read each in as follows:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{path.to.files =}\StringTok{ "../set3/individual/"}
\NormalTok{path.to.llrs =}\StringTok{ "../set3/individual/llrs/"}
\NormalTok{files =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\KeywordTok{list.files}\NormalTok{(path.to.files, }\DataTypeTok{pattern =} \StringTok{".rds"}\NormalTok{, }\DataTypeTok{full.name =} \OtherTok{TRUE}\NormalTok{), }\KeywordTok{list.files}\NormalTok{(path.to.llrs, }
    \DataTypeTok{pattern =} \StringTok{"wide"}\NormalTok{, }\DataTypeTok{full.name =} \OtherTok{TRUE}\NormalTok{))}
\NormalTok{features =}\StringTok{ }\KeywordTok{lapply}\NormalTok{(files, function(x) }\KeywordTok{readRDS}\NormalTok{(x))}

\CommentTok{# make one set of adjustments}
\NormalTok{features[[}\DecValTok{1}\NormalTok{]] =}\StringTok{ }\KeywordTok{do.call}\NormalTok{(}\StringTok{"rbind"}\NormalTok{, features[[}\DecValTok{1}\NormalTok{]])}
\end{Highlighting}
\end{Shaded}

Keep in mind that long files have 20,166 rows and wide files have 6722
rows. Wide files should have columns identified as \verb!couponCol!:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{wideSet =}\StringTok{ }\KeywordTok{c}\NormalTok{()}
\NormalTok{longSet =}\StringTok{ }\KeywordTok{c}\NormalTok{()}
\NormalTok{noSet =}\StringTok{ }\KeywordTok{c}\NormalTok{()}
\NormalTok{for (i in }\DecValTok{1}\NormalTok{:}\KeywordTok{length}\NormalTok{(features)) \{}
    \NormalTok{if (}\KeywordTok{nrow}\NormalTok{(features[[i]]) ==}\StringTok{ }\DecValTok{20166}\NormalTok{) \{}
        \NormalTok{longSet =}\StringTok{ }\KeywordTok{c}\NormalTok{(longSet, i)}
    \NormalTok{\} else \{}
        \NormalTok{if (}\KeywordTok{nrow}\NormalTok{(features[[i]]) ==}\StringTok{ }\DecValTok{6722}\NormalTok{) \{}
            \NormalTok{wideSet =}\StringTok{ }\KeywordTok{c}\NormalTok{(wideSet, i)}
        \NormalTok{\} else \{}
            \NormalTok{noSet =}\StringTok{ }\KeywordTok{c}\NormalTok{(noSet, i)}
        \NormalTok{\}}
    \NormalTok{\}}
\NormalTok{\}}

\NormalTok{## wide format sets:}
\NormalTok{wideSet}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   [1]   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18
##  [18]  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35
##  [35]  36  37  38  39  40  41  42  43  44  45  46  47  48  49  50  51  52
##  [52]  53  54  55  56  57  58  59  60  61  62  63  64  65  66  67  68  69
##  [69]  70  71  72  73  74  75  76  77  78  79  80  81  82  83  84  85  86
##  [86]  87  88  89  90  91  92  93  94  95  96  97  98  99 100 101 102 103
## [103] 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120
## [120] 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137
## [137] 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154
## [154] 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171
## [171] 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188
## [188] 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205
## [205] 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222
## [222] 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239
## [239] 240 241
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{## long format sets:}
\NormalTok{longSet}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## NULL
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{## no format sets:}
\NormalTok{noSet}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

in this case, sets ../set3/individual//HTVmelt3\_Combn\_UniqueUser.rds
have no proper place. We can figure out why this is by doing the
following:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{features[[noSet[}\DecValTok{1}\NormalTok{]]] %>%}\StringTok{ }\KeywordTok{select}\NormalTok{(orderID) %>%}\StringTok{ }\KeywordTok{arrange}\NormalTok{(orderID) %>%}\StringTok{ }\NormalTok{head}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   orderID
## 1       1
## 2       1
## 3       1
## 4       2
## 5       2
## 6       2
\end{verbatim}

The first set appears to be long. We can join by couponID:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{features[[noSet[}\DecValTok{1}\NormalTok{]]] =}\StringTok{ }\NormalTok{features[[noSet[}\DecValTok{1}\NormalTok{]]][, -}\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{:}\DecValTok{22}\NormalTok{, }\DecValTok{24}\NormalTok{:}\DecValTok{31}\NormalTok{)] %>%}\StringTok{ }\KeywordTok{arrange}\NormalTok{(orderID, }
    \NormalTok{couponCol) %>%}\StringTok{ }\KeywordTok{select}\NormalTok{(-couponID) %>%}\StringTok{ }\KeywordTok{gather}\NormalTok{(varname, value, -couponCol, }
    \NormalTok{-orderID) %>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{colname =} \KeywordTok{paste0}\NormalTok{(varname, }\StringTok{"_"}\NormalTok{, couponCol)) %>%}\StringTok{ }\KeywordTok{select}\NormalTok{(orderID, }
    \NormalTok{colname, value) %>%}\StringTok{ }\KeywordTok{spread}\NormalTok{(colname, value)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{features[[noSet[}\DecValTok{1}\NormalTok{]]] %>%}\StringTok{ }\KeywordTok{arrange}\NormalTok{(orderID) %>%}\StringTok{ }\KeywordTok{select}\NormalTok{(orderID) %>%}\StringTok{ }\NormalTok{head}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   orderID
## 1       1
## 2       2
## 3       3
## 4       4
## 5       5
## 6       6
\end{verbatim}

\subsubsection{Combine Wide Sets:}\label{combine-wide-sets-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{wideFrame =}\StringTok{ }\NormalTok{features[[noSet[}\DecValTok{1}\NormalTok{]]]}
\NormalTok{for (x in wideSet) \{}
    \NormalTok{dsn.i =}\StringTok{ }\NormalTok{features[[x]]}
    \NormalTok{dropCols =}\StringTok{ }\KeywordTok{which}\NormalTok{(}\KeywordTok{names}\NormalTok{(dsn.i) %in%}\StringTok{ }\KeywordTok{names}\NormalTok{(wideFrame) &}\StringTok{ }\KeywordTok{names}\NormalTok{(dsn.i) !=}\StringTok{ "orderID"}\NormalTok{)}
    \NormalTok{dropCols =}\StringTok{ }\KeywordTok{c}\NormalTok{(dropCols, }\KeywordTok{which}\NormalTok{(}\KeywordTok{grepl}\NormalTok{(}\StringTok{"times(N*o*t*)Used*_"}\NormalTok{, }\KeywordTok{names}\NormalTok{(dsn.i))))}
    \NormalTok{if (}\KeywordTok{length}\NormalTok{(dropCols) ==}\StringTok{ }\DecValTok{0}\NormalTok{) \{}
        \NormalTok{wideFrame =}\StringTok{ }\NormalTok{wideFrame %>%}\StringTok{ }\KeywordTok{full_join}\NormalTok{(dsn.i, }\DataTypeTok{by =} \StringTok{"orderID"}\NormalTok{)}
    \NormalTok{\} else \{}
        \NormalTok{wideFrame =}\StringTok{ }\NormalTok{wideFrame %>%}\StringTok{ }\KeywordTok{full_join}\NormalTok{(dsn.i[, -dropCols], }\DataTypeTok{by =} \StringTok{"orderID"}\NormalTok{)}
    \NormalTok{\}}
\NormalTok{\}}
\KeywordTok{names}\NormalTok{(wideFrame) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_[Cc]ol(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d+)$"}\NormalTok{, }\StringTok{"_}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{1"}\NormalTok{, }\KeywordTok{names}\NormalTok{(wideFrame))}
\KeywordTok{names}\NormalTok{(wideFrame) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"(^.*[^_0-9])(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d+)$"}\NormalTok{, }\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{1_}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{2"}\NormalTok{, }\KeywordTok{names}\NormalTok{(wideFrame))}
\NormalTok{wideFrame =}\StringTok{ }\NormalTok{wideFrame[, }\KeywordTok{which}\NormalTok{(!}\KeywordTok{grepl}\NormalTok{(}\StringTok{"times(N*o*t*)Used*_"}\NormalTok{, }\KeywordTok{names}\NormalTok{(wideFrame)))]}
\end{Highlighting}
\end{Shaded}

\subsubsection{Long Version}\label{long-version-3}

We can also convert this set to the long format. Notice that not all of
the files are the same ``wide'' as others, but we would still like to
use them:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{coln =}\StringTok{ }\KeywordTok{names}\NormalTok{(wideFrame)}
\NormalTok{non_numbered_cols =}\StringTok{ }\KeywordTok{which}\NormalTok{(!}\KeywordTok{grepl}\NormalTok{(}\StringTok{"_}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d+$"}\NormalTok{, coln))}
\NormalTok{coupon1_cols =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{grep}\NormalTok{(}\StringTok{"_(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)1(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)$"}\NormalTok{, coln))}
\NormalTok{coupon2_cols =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{grep}\NormalTok{(}\StringTok{"_(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)2(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)$"}\NormalTok{, coln))}
\NormalTok{coupon3_cols =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{grep}\NormalTok{(}\StringTok{"_(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)3(}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{d*)$"}\NormalTok{, coln))}

\NormalTok{## coupon 1}
\NormalTok{coupon1 =}\StringTok{ }\NormalTok{wideFrame[, coupon1_cols]}
\KeywordTok{names}\NormalTok{(coupon1) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_13$"}\NormalTok{, }\StringTok{"_to3Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon1))}
\KeywordTok{names}\NormalTok{(coupon1) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_12$"}\NormalTok{, }\StringTok{"_to2Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon1))}
\KeywordTok{names}\NormalTok{(coupon1) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_1$"}\NormalTok{, }\StringTok{""}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon1))}
\NormalTok{coupon1$couponCol =}\StringTok{ }\DecValTok{1}

\NormalTok{## coupon 2}
\NormalTok{coupon2 =}\StringTok{ }\NormalTok{wideFrame[, coupon2_cols]}
\KeywordTok{names}\NormalTok{(coupon2) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_23$"}\NormalTok{, }\StringTok{"_to3Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon2))}
\KeywordTok{names}\NormalTok{(coupon2) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_12$"}\NormalTok{, }\StringTok{"_to1Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon2))}
\KeywordTok{names}\NormalTok{(coupon2) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_2$"}\NormalTok{, }\StringTok{""}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon2))}
\NormalTok{coupon2$couponCol =}\StringTok{ }\DecValTok{2}

\NormalTok{## coupon 3}
\NormalTok{coupon3 =}\StringTok{ }\NormalTok{wideFrame[, coupon3_cols]}
\KeywordTok{names}\NormalTok{(coupon3) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_23$"}\NormalTok{, }\StringTok{"_to2Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon3))}
\KeywordTok{names}\NormalTok{(coupon3) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_13$"}\NormalTok{, }\StringTok{"_to3Col"}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon3))}
\KeywordTok{names}\NormalTok{(coupon3) =}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_3$"}\NormalTok{, }\StringTok{""}\NormalTok{, }\KeywordTok{names}\NormalTok{(coupon3))}
\NormalTok{coupon3$couponCol =}\StringTok{ }\DecValTok{3}

\NormalTok{coupons =}\StringTok{ }\KeywordTok{bind_rows}\NormalTok{(coupon1, coupon2, coupon3)}

\NormalTok{longFrame =}\StringTok{ }\NormalTok{coupons %>%}\StringTok{ }\KeywordTok{arrange}\NormalTok{(orderID, couponCol)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Check Universal
Features}\label{check-universal-features-3}

We can check the final results:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{dim}\NormalTok{(wideFrame)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 6722 3277
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{dim}\NormalTok{(longFrame)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 20166  1094
\end{verbatim}

\subsubsection{Save Universal}\label{save-universal-3}

These are our universal features:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{saveRDS}\NormalTok{(wideFrame, }\DataTypeTok{file =} \StringTok{"../set3/combined/set3FeaturesCombined_wide.rds"}\NormalTok{)}
\KeywordTok{saveRDS}\NormalTok{(longFrame, }\DataTypeTok{file =} \StringTok{"../set3/combined/set3FeaturesCombined_long.rds"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\end{document}
